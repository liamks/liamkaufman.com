
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Liam Kaufman</title>
  <meta name="author" content="Liam Kaufman">

  
  <meta name="description" content="Being nice to your customers seems like a no brainer. It makes perfect business since: happy customers are less likely to stop using your service &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://liamkaufman.com">

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/liamkaufman/uHFr" rel="alternate" title="Liam Kaufman" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1004776-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
 
  <h1><a href="/">Liam Kaufman</a></h1>
  
    <h2>Software Developer and Entrepreneur</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/liamkaufman/uHFr" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:liamkaufman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about.html">About</a></li>
  <li><a href="/projects.html">Projects</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/21/why-you-should-be-nice-to-your-customers/">Why You Should Be Nice to Your Customers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-21T00:00:00-05:00" pubdate data-updated="true">Nov 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Being nice to your customers seems like a no brainer. It makes perfect business since: happy customers are less likely to stop using your service and more likely to refer your service to their friends. However, there is another significant reason that being nice pays off. 
</p>
<p>
Running a startup can be a tough slog. You’re unsure if people like what you&#8217;re building enough for it to be successful. If you get some traction there will be people out there that will belittle your idea, or your execution. With all the unknowns, and the not-always-constructive criticism, it’s incredibly refreshing to interact with a nice customer that loves your product. 
</p>
<p> 
I’ve noticed that the nicer I am to customers the nicer they are back. This virtuous circle means that we get more and more people who are willing to provide thoughtful criticism and who are willing to meet with us and give us feedback. We have one customer that loves <a href="https://understoodit.com">Understoodit</a> so much that he just finished writing a blog post for us (to be posted in the next week). 
</p>
<p>  
After a difficult day in startup land it’s really gratifying to interact with a nice customer. It puts a face to an email address and makes the whole process of building software that much more interesting and fulfilling.
</p>
<p>
Make sure you’re nice to your customers, they may just be nice back. 
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/09/stripe-would-be-perfect-if/">Stripe Would Be Perfect If&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-09T00:00:00-05:00" pubdate data-updated="true">Nov 9<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
I was among many Canadian developers who where happy to hear that Stripe had come to Canada. We were planning on adding subscriptions to <a href="https://understoodit.com">Understoodit.com</a>, so the timing couldn’t have been better. We assumed that it would take a couple of days to integrate Stripe, but it actually took <a href="https://twitter.com/davidmisshula">@davidmisshula</a> and me 7 days. The process gave me some insights that I thought I’d share.
</p>
<p>
I’ve heard that Stripe is significantly easier to integrate than its competitors, however, having never integrated a payment system I have no comparison. Overall I think Stripe is excellent and I’m glad we chose it, however, there are 4 areas, that if improved, would make Stripe perfect: 1) getting started, 2) taxes, 3) invoices and 4) edge cases.
</p>
<h2>Getting Started</h2>
<p>
Having never integrated a payment system into a website I wanted to be as careful as possible. I wanted to make sure that I understood as many details as possible, and had time to carefully map out all the things that needed to be done before pushing it to production. What I would have really liked was a diagram of how Stripe worked. A good diagram is much easier for me to parse, and would have helped me to understand the text documentation much quicker.
</p>
<p>
For instance, below is one possible diagram that would show the potential set of events associated with a new user signing up for a subscription plan.
</p>
<div>
<img src="/images/Stripe-Diagram.png" alt="A diagram of Stripe Payments">
</div>
<h2>Taxes</h2>
<p style="text-align:center;">
<img src="/images/stripe-response.png" alt="Stripe response to does it deal with taxes">
</p>
<p>
Understoodit is based in Canada, obligating us to collect taxes from Canadians, but not our international customers. The kicker is that different provinces have different tax rates. In total there are 4 different tax rates and then no taxes for international customers, for a total of 5 different tax levels. We currently have 3 monthly plans, and their 3 yearly equivalents. This means that we had to create (3 + 3) x 5 = 30 plans within Stripe.
</p>
<p>
It would have been significantly easier if Stripe had had a ‘tax’ feature, in the same way they have coupons. If such a feature existed we’d only have had to create 6 plans in Stripe and 4 tax levels. This would result in Stripe invoices including the subtotal, amount of taxes and total (one less thing for us to calculate). While Stripe does a great job of prorating payments, when a user switches from one plan to another, it becomes tricky for us when they switch province. While calculating taxes isn’t that difficult for us to do, it’s just one more thing we have to get right. It’s one more thing we have to calculate when sending an invoice to our customers.
</p>
<h2>Invoices</h2>
<p style="text-align:center;">
  <img src="/images/37signals-invoice.png" alt="picture of a 37 signals invoice">
</p>
<p>
Every online subscription that I currently have sends me a simple invoice at the end of each billing period. Some have .pdfs attached that I can easily send to an accountant. Additionally, those services include admin panels that list all the past invoices and those can easily be downloaded as pdfs. 
</p>
<p>
It would be amazing if Stripe handled 1) emailing invoices and 2) creating a .pdfs of each invoice. Developers could provide simple HTML templates for email and pdf invoices and Stripe would fill in the blanks and send the invoice at the correct time, to the correct user. I suspect people would be willing to pay extra for this feature.
</p>
<h2>Edge Cases</h2>
<p>
Like any feature, there are multiple edge cases to a payment system. For instance here are a few that we dealt with:
</p>
<ul>
  <li>Upgrade plan, and simultaneously change provinces (e.g. tax rate)</li>
  <li>Downgrade plan and simultaneously change provinces (e.g tax rate)</li>
  <li>Change credit card info, but not billing address</li>
  <li>Change plan, but keep credit card and billing info the same</li>
</ul>

<p>
Stripe employees can no doubt enumerate many more edge cases than someone adding Stripe for the first time. It would be helpful if they provided a checklist of edge cases for developers. The checklist could also include common security concerns that developers should understand before rolling payments out.
</p>
<h2>Conclusions</h2>
<p>
With all the hype on Hacker News, I had this vision of Stripe being magically easy to integrate. While it wasn’t rocket science it was certainly more effort than I envisioned. The whole process was made significantly more difficult by having to handle taxes. 
</p>
<p>
I wonder if there would be value in Stripe conducting the following usability experiment. Get a dozen computer science and engineering undergrads and ask them each to integrate Stripe into an existing website. Stripe employees would sit with them and monitor their progress (or lack of), but provide no help. I suspect that they’d find some surprises in how novices approach Stripe integration. The information gained in such an experiment could help them create better documentation, reduce development burden and ultimately create a more perfect Stripe.
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/09/common-javascript-errors/">Common JavaScript Errors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-09T00:00:00-04:00" pubdate data-updated="true">Sep 9<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
 With the rise of thick client-side applications, and Node.js, JavaScript has become an increasingly important programming language. Despite its simplicity, JavaScript presents some difficulties for those new to the language. I thought it would be useful to outline several JavaScript errors that I commonly made when I was learning the language.
</p>

<h2>Scope: this, that and window</h2>
<p>
  Like many programming languages JavaScript provides internal access to objects using the keyword <code>this</code>. Unfortunately, what <code>this</code> refers to differs depending on what called the function containing <code>this</code>. A common example, shown below, is what happens when <code>setTimeout</code> is called. 
</p>
<p>
  In the example below a Dog object is created, with a bark function. The Dog ralph is instantiated with the name &#8216;Ralph&#8217; and when <code>ralph.bark()</code> is called, &#8220;Ralph&#8221; is printed to the console.
</p>
<p>
   What becomes confusing is what happens when <code>setTimeout</code> is called with the parameters <code>ralph.bark</code> and 500. After 500 milliseconds <code>ralph.bark</code> is called, however, nothing is printed to the console.
</p>

<figure class='code'><figcaption><span>The this problem</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Dog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">name</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Dog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bark</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">ralph</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dog</span><span class="p">(</span><span class="s1">&#39;Ralph&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">()</span>
</span><span class='line'><span class="c1">// Ralph is printed to the console</span>
</span><span class='line'>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span> <span class="p">,</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'><span class="c1">// nothing is printed to the console</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  Mozilla Developer Network refers to the problem above as <a href="https://developer.mozilla.org/en-US/docs/DOM/window.setTimeout">&#8216;The &#8221;<code>this</code>&#8221; problem&#8217;</a>. What happens is <code>this</code> within <code>bark()</code> refers to the browser&#8217;s <code>window</code> variable when <code>bark()</code> is called from setTimeout.
</p>

<h3>Avoiding the <code>this</code> problem.</h3>
<figure class='code'><figcaption><span>Solutions to the this problem.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Works in JavaScript 1.8.5</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">ralph</span><span class="p">),</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using jQuery</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">,</span> <span class="nx">ralph</span> <span class="p">),</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using undescore.js</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">,</span> <span class="nx">ralph</span> <span class="p">),</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using an anonymous function</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">();</span> <span class="p">},</span> <span class="mi">500</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>
<p>In each of the above the bind, or proxy functions explicity ensure that <code>this</code> within <code>ralph.bark</code> refers to ralph and not <code>window</code>. In the final example an anonymous function is called and provides another way of fixing the <code>this</code> problem.</p>

<h2>Callbacks in Loops</h2>
<p>When I launched <a href="understoodit.com">Understoodit.com</a> in May I included a waitlist for interested users to signup. I was planning on inviting a few dozen users a day, however, due to a deluge of emails sending out invites was delayed by a week or two. 
</p>
<p>
To send the invites out, I went to Understoodit&#8217;s admin panel and seleted 40 people on the waiting list and clicked invite. A few days later I noticed that only a few individuals had accepted the invite. I looked at Postmark&#8217;s logs and noticed that invites were only sent to 5 individuals. What&#8217;s more those 5 individuals had received anywhere from 5 - 15 emails each. Meanwhile, the other 35 invitees had received no emails. The bug: I had a callback in a loop that iterated over all the selected invities and 1) called databaseModule.addInvitedUser, which created an invite token and added that invite to the database and 2) sent an email with the newly created token. Below is a simplification of the code, with error handling removed.</p>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">sendInviteEmails</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">emails</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">databaseModule</span><span class="p">.</span><span class="nx">addInvitedUser</span><span class="p">(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">token</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">emailModule</span><span class="p">.</span><span class="nx">sendInvite</span><span class="p">(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  What went wrong was that the anonymous function <a href="http://stackoverflow.com/a/3023979/146099">&#8220;captures the variable i, not its value&#8221;</a>.  The value of <code>i</code> is dependent on when the anonymous function is called, which varries depending on how long it takes to add the invited user to the database.
</p>
<p>
  The solution I used was to wrap the anonymous function with an <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">immediately invoked function expression</a> (IIFE). The IIFE &#8220;locks&#8221; in the value of <code>i</code> ensuring that <code>emailModule.sendInvite()</code> refers to a different value of i on each IIFE call. Alternatively, one could create a second function outside of the loop and then call that (see option 2), a solution that would likely be easier to read. 
</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// option 1</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendInviteEmails</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">emails</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">databaseModule</span><span class="p">.</span><span class="nx">addInvitedUser</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">token</span> <span class="p">){</span>
</span><span class='line'>        <span class="nx">emailModule</span><span class="p">.</span><span class="nx">sendInvite</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">})(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// option 2</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendOneInviteEmail</span><span class="p">(</span> <span class="nx">email</span> <span class="p">){</span>
</span><span class='line'>  <span class="nx">databaseModule</span><span class="p">.</span><span class="nx">addInvitedUser</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">token</span> <span class="p">){</span>
</span><span class='line'>    <span class="nx">emailModule</span><span class="p">.</span><span class="nx">sendInvite</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendManyInviteEmails</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">emails</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>    <span class="nx">sendOneInviteEmail</span><span class="p">(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  The above quirk seems similar to a fairly common JavaScript interview question that takes the form of <a href="http://tobyho.com/2011/11/02/callbacks-in-loops/">adding event listeners to an array of links</a>.
</p>


<h2>Global Variables</h2>
<p>
  The problems with global variables have been discussed many times before. Suffice it to say that you should avoid them by using <code>var</code> (e.g. <code>var x = 0;</code> vs </code>x = 0;</code>) when first declearing a variable. If you have a variable that has unaccounted for properties or values, there&#8217;s a chance that a global variable could be to blame.
</p>
<p>
  I&#8217;d highly recommend defining all your variables at the top of the function to make it as clear as possible when a var is missing. Furthermore I&#8217;d recommend using <a href="http://www.jshint.com/">JSHint</a> which can warn you of global variables.
</p>

<h2>Values in HTML forms</h2>

<figure class='code'><figcaption><span>A drop down menu</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;order-sizes&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>Small<span class="nt">&lt;/option&gt;</span>
</span><span class='line'>  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>Medium<span class="nt">&lt;/option&gt;</span>
</span><span class='line'>  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>Large<span class="nt">&lt;/option&gt;</span>
</span><span class='line'><span class="nt">&lt;/select&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>When it comes time to get the form&#8217;s values, and use them within an application, I usually do something like: </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">orderSize</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#order-sizes option:selected&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Thanks for ordering a small!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Unfortunately the value that jQuery returns is a <code>String</code>, and comparing it to 1, a <code>Number</code> returns false. Here are several solutions to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// last solution</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">orderSize</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#order-sizes option:selected&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  In the first two examples orderSize is explicitly converted to a <code>Number</code> using the <code>Number</code> constructor and the global <code>parseInt</code> function. In the third example the double equals coerces orderSize to a <code>Number</code> before comparing to 1 (<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Operators/Comparison_Operators?redirectlocale=en-US&redirectslug=Core_JavaScript_1.5_Reference%2FOperators%2FComparison_Operators">MDN on comparison operators</a>). However, I&#8217;d recommend going with the last approach, which allows you to use orderSize as a <code>Number</code> in multiple spots without having to repeatedly caste to a number. If you don&#8217;t like the last approach I&#8217;d recommend the first or second approach, since it seems to be generally preferred to use the strict equal (tripple equal signs) and not to use the double equal sign.
</p>

<h2>Conclusions</h2>
<p>
  Many of the above errors can be avoided by following JavaScript style guides (<a href="http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml">Google JavaScript Style Guide</a>, <a href="http://addyosmani.com/blog/javascript-style-guides-and-beautifiers/">Addy Osmani on Style Guides</a>). A sign of how tricky JavaScript is comes from <a href="https://github.com/styleguide/javascript">Github&#8217;s JavaScript Style guide</a> that goes as far to recommend avoiding JavaScript altogether and using CoffeeScript - a suggestion a few would disagree with!
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/04/redis-and-relational-data/">Redis and Relational Data</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-04T00:00:00-04:00" pubdate data-updated="true">Jun 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
  <strong>UPDATE:</strong> Based on the feedback in the comments (Phineas), I&#8217;ve added an index to the comments table and updated the results.
</p>
<p>
  Using the right tool for the job is a basic tenant amongst programmers. However, with all the currently available database options it&#8217;s increasingly difficult to figure out what the right tool is. Sometime it&#8217;s nice to have a very simple tool that can be used for many different tasks: Redis. Over the last 4 months I&#8217;ve been using Redis heavily and I&#8217;ve even started to use it for relational data. I&#8217;ve been curious to find out the performance differences between Redis and PostgreSQL. Below I&#8217;ll provide an example of storing a simple relational dataset in Redis, and I&#8217;ll look at the performance differences between Redis and PostgreSQL.
</p>

<h2>Why use Redis for Relational data?</h2>
<p>
  I find Redis appealing because it&#8217;s the simplest database that I have ever used (relative to: MySQL, PostgreSQL, Riak &amp; Mongo). The documentation includes the time complexity of each command, and the documentation provides an interactive console to experiment with a given command. There&#8217;s also a certain appeal to using a single database instead of 2 or 3: 
  <ol>
    <li>It&#8217;s much quicker to master 1 database than 2.</li>
    <li>Two different databases means twice the updates, bugs and crashes.</li>
  </ol>
</p>

<p>
  I&#8217;ll outline a few ways Redis can be used to store relational data and the performance differences between redis and PostgreSQL. All the examples and performance tests were done using Node.js.
</p>

<h2>Storing Relational Data in Redis</h2>

<p>
  Redis values can be 1 of 5 different datatypes: strings, hashes, lists, sets and sorted sets. Each row in a relational database can be represented using a hash, and a list, set or sorted set can be used to represent a table. The datatype that&#8217;s used to represent the table is dependent on how the data needs to be retrieved.
</p>

<p>
  For example, let&#8217;s say we&#8217;re storing blog posts. In Redis, each post will be stored in its own hash, with its key corresponding to the post&#8217;s url:
</p>

<figure class='code'><figcaption><span>A Post</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s1">&#39;a-post-about-databases&#39;</span> <span class="o">:</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;A post about databases&#39;</span><span class="p">,</span> <span class="nx">body</span> <span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="nx">createdAt</span> <span class="o">:</span> <span class="mi">1338751532301</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  Retrieving a single post using the url becomes O(N), where N is the size of the hash (post). Since the number of keys in a post is constant, retrieving that post becomes O(1). However, if we wanted to get all the posts, or a subset of them, it becomes useful to also store the keys in a sorted set (e.g. the &#8220;table&#8221;). Using a sorted set means that posts can be stored by their createdAt date and it allows us to retrieve all the posts, or a subset of them (useful for pagination).
</p>


<figure class='code'><figcaption><span>Retrieving a subset of all posts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">redis</span><span class="p">.</span><span class="nx">zrange</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">posts</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//return the keys (urls) associated with the first 11 posts</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">startDate</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">getTime</span><span class="p">()</span> <span class="p">;</span> <span class="c1">// June 1st</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">endDate</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">)).</span><span class="nx">getTime</span><span class="p">();</span> <span class="c1">// June 30th</span>
</span><span class='line'><span class="nx">redis</span><span class="p">.</span><span class="nx">zrangebyscore</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">startDate</span><span class="p">,</span> <span class="nx">endDate</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">posts</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//returns the keys (urls) associated with all the posts from June 2012</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  The above example is relatively straight forward, but what about storing the post&#8217;s comments? For every post we create a new sorted set called: &#8216;comments-KEYofPOST&#8217;. The comments are sorted by their creation time. To get a post, and its comments, we could do the following:
</p>

<figure class='code'><figcaption><span>Storing a post&#8217;s comments</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">postURL</span> <span class="o">=</span> <span class="s1">&#39;a-post-about-databases&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// queue up the queries</span>
</span><span class='line'><span class="nx">multi</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="nx">postURL</span><span class="p">);</span>
</span><span class='line'><span class="nx">multi</span><span class="p">.</span><span class="nx">zrange</span><span class="p">(</span><span class="s1">&#39;comments-&#39;</span> <span class="o">+</span> <span class="nx">postURL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// execute the queries atomically</span>
</span><span class='line'><span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">){</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  results[0] will contain the post</span>
</span><span class='line'><span class="cm">  results[1] will contain an array with all the comments</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Redis vs. PostgreSQL Performance</h2>

<p>
  In SQL you might do 1 query to get the post and another to get the comments, or use a join to get the post and the comments in one query. With the approach above, using Redis, 2 queries are atomically executed, using the multi and exec commands. Both in PostgreSQL, and Redis, a single request is sent the database to retrieve 1 post and its 10 comments.
</p>

<p>
  To test the the performance I created a dataset that includes 10,000 &#8216;blog posts&#8217;, with each post having 10 comments (100,000 comments in total). All tests were run on a 2011 Macbook Pro (2.3 GHz i7, 8GB RAM). To test PostgreSQL, I sequentially fetched each post and used a join to retrieve its comments (10,000 separate queries). The test was repeated six times to produce an average time and was done for both PostgreSQL and Redis.
</p>

<div class="table">
  <h2>Redis &amp; PostgreSQL Performance</h2>
  <table>
    <tr>
      <th></th>
      <th>Average Time (Seconds)</th>
      <th>Query (Milliseconds)</th>
    </tr>

    <tr>
      <td>psql</td>
      <td>138.34</td>
      <td>13.8</td>
    </tr>

    <tr>
      <td>psql (Native Bindings - NB)</td>
      <td>125.95</td>
      <td>12.6</td>
    </tr>

    <tr>
      <td>psql (NB + Index)</td>
      <td>2.72</td>
      <td>0.27</td>
    </tr>

    <tr>
      <td>Redis (Hires)</td>
      <td>0.76</td>
      <td>0.067</td>
    </tr>

  </table>
</div>

<p>
  Using PostgreSQL, it took an average of 138.34 seconds to execute all 10,000 queries, or 13.8 milliseconds/query. Using the native bindings, that come with the psql node module, yielded an improvement and was associated with 12.6 milliseconds/query. When an index was added to comments (post_id), the time dropped to 2.72 seconds, or 0.27 milliseconds for a post and its 10 comments. In contrast, Redis can retrieve a post and its comments in 0.067 milliseconds. Of course the above is akin to comparing apples to oranges, but it still provides a glimpse into the performance differences between Redis and PostgreSQL.
</p>
<p>
  While Redis is in memory and should be fast, PostgreSQL uses caching algorithms (<a href="http://archives.postgresql.org/pgsql-hackers/2007-11/msg00562.php">LRU</a>) to keep its contents in memory. Of course, keeping everything in memory (Redis) will most likely be faster than using LRU.
</p>

<h2>Caveats to using Redis for Relational Data</h2>

<p>
  The single biggest caveat to using Redis, is that it is entirely in memory. If your relational dataset is 2.5GB (not that large), you&#8217;ll need a $160/month Linode (4GB RAM) to keep it in Redis. In contrast, a $20/month Linode (512MB RAM) has 20GB of disk space and could easily hold that same dataset using PostgreSQL. This tradeoff becomes even more of an issue as your dataset become larger than 4GB. 
</p>

<p>
  The above example only represents a very simple relationship between two pieces of data (posts and comments), mapping a many-to-many relationship in Redis would take a little more imagination. 
</p>

<h2>Conclusions</h2>
<p>
  Before storing all your app&#8217;s data in Redis it&#8217;s advisable to estimate how large your dataset will be in a year, or two, and how much much RAM will be required to use Redis. If your dataset will be greater than 4GB in a year, and money is a constraint, it probably makes sense to put all, or a portion of the data, in PostgreSQL, or use an alternative noSQL solution (e.g. Riak or Mongo).
</p>

<p>
<a class="github" href="https://github.com/liamks/Redis-and-Relational-Data"><span></span>Code on Github</a>
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/21/adding-authentication-waiting-lists-and-sign-ups-to-and-express-app-using-drawbridge-and-redis/">Adding Authentication, Waiting Lists and Sign Ups to an Express App Using Drawbridge.js and Redis</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-21T00:00:00-04:00" pubdate data-updated="true">Apr 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
There are several popular modules for adding password-based user authentication to an Express.js app. Unfortunately, they require writing lots of code to get started. I prefer the approach that authentication libraries like Devise take: they generate code and views, and you’re free to modify, or delete, what’s created. 
</p>

<p>
Given the authentication options for Express.js I wanted to create a module that would make adding user authentication quick and easy. Moreover, I also wanted developers to be free to edit and modify the generated views. In addition to authentication I wanted the module to handle sign ups (the type you see on a just-launched startup’s page) and to handle waiting lists and invitations. Based on the module&#8217;s functionality I&#8217;ve decided to call it Drawbridge.js.
</p>

<h2>User Authentication with Drawbridge.js</h2>
<p>
Drawbridge.js uses Redis to persists its data, but it’s possible for developers to create other database adapters for Drawbridge (pull-requests accepted). I chose Redis because its ability to pipeline multiple commands reducing round trips between the server and the database. The atomic nature of pipelined commands obviates a lot of complex callbacks and makes the resulting code much easier to understand. Overall Redis is easy to use, easy to understand and fast - great features for an authentication module. 
</p>
<p>
To send email, Drawbridge uses either nodemailer, or the postmark modules. I included the <a href="https://postmarkapp.com">Postmark</a> option because I&#8217;m currently using it and I like it. However, developers are free to add additional email adapters.
</p>

<h2>Drawbridge Screencast</h2>
<p>
I’ve created a short screencast to show how easy it is to add drawbridge to an existing Express.js application. Before you watch the screencast it’s important that I outline a couple of caveats:
</p>
<p>
  <ol>
    <li>Drawbridge is not ready for production - it’s basically a working prototype.</li>
    <li>Drawbridge views and variables are inconsistently named, that will need to be fixed.</li>
    <li>The code needs refactoring and more testing.</li>
    <li>Drawbridge needs to be picked apart for security issues.</li>
  </ol>
</p>
<p>
With those caveats out of the way here is the video:
</p>

<p>
<iframe src="http://player.vimeo.com/video/40780990?title=0&amp;byline=0&amp;portrait=0" width="400" height="300" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe><p><a href="http://vimeo.com/40780990">Drawbridge.js</a> from <a href="http://vimeo.com/user11381617">Liam Kaufman</a> on <a href="http://vimeo.com">Vimeo</a>.</p>
</p>

<p>
While I built Drawbridge.js to scratch my own itch, I hope others will find it useful as well. Once I refine it further I will most certainly start to use it in my own projects. If you’re interested in Drawbridge 1) watch the project on Github and 2) try and get it working on your toy Express apps. I welcome feedback on both the architecture of Drawbridge and its security.
</p>

<p>
<a class="github" href="https://github.com/liamks/Drawbridge.js"><span></span>Drawbridge.js on Github</a>
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/22/making-hacker-news-faster-two-approaches/">Making Hacker News Faster: Two Approaches</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-22T00:00:00-04:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Over the years traffic to <a href="http://news.ycombinator.com">Hacker News (HN)</a>, &#8220;a social news website about computer hacking and startup companies&#8221; <a href="http://en.wikipedia.org/wiki/Hacker_News">(Wikipedia)</a>, has grown consistently, with an <a href=”http://www.ycombinator.com/images/hntraffic-5mar12.png”>average of 150,000 daily uniques</a>. The growth in traffic may explain why load times seem increasingly variable. I couldn’t help but wonder if some optimizations could be made to decrease both variability and load times. I&#8217;ll propose two broad approaches, the first involves migrating away from table based layouts while the second involves consuming a JSON API.
</p>

<h2> Approach 1: Tables to Divs </h2>

<div class="table">
  <h2> Table 1. Hacker News Resource Statistics </h2>
  <table>
    <tr>
      <th>Resource</th>
      <th>Size (With Tables) </th>
      <th>Size (With Divs) </th>
      <th>% Change </th>
    </tr>
    <tr>
      <td>HTML</td>
      <td>26KB</td>
      <td>15KB</td>
      <td>-42%</td>
    </tr>
    <tr>
      <td>CSS</td>
      <td>1.7KB</td>
      <td>2.3KB</td>
      <td>+35%</td>
    </tr>
    <tr>
      <td>Logo</td>
      <td>100B</td>
      <td>0</td>
      <td>-100%</td>
    </tr>
    <tr>
      <td>Up Arrow</td>
      <td>111B</td>
      <td>0</td>
      <td>-100%</td>
    </tr>
    <tr>
      <td>Total</td>
      <td>27.9KB</td>
      <td>17.3KB</td>
      <td>-37.2%</td>
    </tr>
  </table>
  <p>
    In the DIV version, the logo and up arrow were base 64 encoded and included in the HTML and CSS files. 
  </p>
</div>

<p>
  HN&#8217;s front page is comprised of: 4 tables, 98 rows, 159 columns, 37 inline style declarations and numerous attributes that dictate style. To reduce the markup on the front page I created a new HN front page (<a href="https://github.com/liamks/Making-HN-Faster/blob/master/HackerNewsV2.html">Github link</a>) that looks identical to the existing page but does not include tables or inline css. I also went a step further and base64 encoded both the logo and the up arrow to decrease the number of requests. The completed CSS file was run through a <a href="http://www.minifycss.com/css-compressor/">css minifyer</a> to yield further reductions. With those changes only two requests are necessary, one for the HTML file and one for the CSS file. Table 1 shows that those changes yielded an overall reduction of 37%.
</p>

<p>
  I also slightly modified the JavaScript responsible for sending up-votes to the server. Instead of grabbing a vote&#8217;s id from the id of the HTML node, it gets it from the &#8216;data-id&#8217; attribute. Otherwise, the JavaScript remains identical. As an aside, if you have not examined the JavaScript that is responsible for sending votes to the server, I&#8217;ve included it below (the existing code). It&#8217;s a creative use of an image tag. An image node is created, but not added to the DOM. When the image node is assigned a &#8216;src&#8217;, which happens to include all the vote info, it then requests the &#8216;image&#8217;, using the constructed url. Thus the &#8216;image&#8217; request becomes analogous to an AJAX GET request, but without a conventional response.
</p>

<figure class='code'><figcaption><span>Votes With IMG Nodes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">byId</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/_/</span><span class="p">);</span>   <span class="c1">// {&#39;up&#39;, &#39;123&#39;}</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// hide arrows</span>
</span><span class='line'>  <span class="nx">byId</span><span class="p">(</span><span class="s1">&#39;up_&#39;</span>   <span class="o">+</span> <span class="nx">item</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">byId</span><span class="p">(</span><span class="s1">&#39;down_&#39;</span> <span class="o">+</span> <span class="nx">item</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ping server</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ping</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">ping</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// cancel browser nav</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2> Approach 2: JSON API </h2>
<p>
  Although approach 1 results in a 37% decrease in data transferred to the client, markup and data must be transferred to the client on every refresh. In approach two, the markup is only transferred to the client once, and then cached, while the data is sent the client via JSON. Using this approach would decrease the HTML file but no doubt increase the JavaScript file. However, both of those resources could be cached in browser, and cached on a CDN, drastically reducing the number of requests to HN&#8217;s server. Furthermore, the JSON representing the stories on the front page <a href="https://github.com/liamks/Making-HN-Faster/blob/master/frontpage.json">is 7.8KB</a>, much smaller than the amount size of the existing solution or even approach 1.
</p>

<p>
  Approach 2 is not without its drawbacks. It would require significant changes in both HN&#8217;s backend and large changes to the client-side. A JavaScript application and API would have to be created. This approach would likely be incompatible with bots that would not execute the JavaScript necessary to populate the page with stories. To get around this the agent-type could be detected and a static version could be served to bots. Alternatively, the webpage could be pre-populated with stories and subsequent requests would take advantage of AJAX get requests. This would simplify matters, but make caching more difficult, since the cache page would require updating every time the front page changes.
</p>

<h2> Conlusions </h2>
<p>
  By transitioning from tables to divs, and inline css to external css, HN could dramatically reduce the bandwidth required to serve its web pages. The first approach would require minimal changes to HN&#8217;s back-end making it a good candidate for adoption. While the second approach could yield even better results, it would require drastic changes to both the server and the client, making it more suitable as a long term solution.
</p>
<p>
  In addition to the two approaches above, gzip compressing both the .html and the .css would further reduce transferred data. It would also be beneficial to add the appropriate headers to enable browser caching for CSS.
</p>
<p>
  While Paul Graham may have insufficient time, or interests, in implementing some of the above changes, I suspect he knows a few individuals who would be willing to help out.
</p>

<p>
<a class="github" href="https://github.com/liamks/Making-HN-Faster"><span></span>Code on Github</a>
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/22/from-digg-to-reddit-to-hacker-news-whats-next/">From Digg to Reddit to Hacker News: What&#8217;s Next?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-22T00:00:00-04:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Dustin Curtis, the creator of <a href="http://svbtle.com/">Svbtle</a>, recently mentioned on <a href="https://twitter.com/#!/dcurtis/status/182986897444966402">Twitter</a>:
</p>
<blockquote>
I miss the Hacker News from four years ago. It was awesome. The discussions there are not even worth reading anymore. It&#8217;s sad.
</blockquote>
<p>
 Based on the number of retweets and favorites, I suspect that others agree. In fact the idea that Hacker News is degrading is common enough that it has been addressed on <a href="http://ycombinator.com/newsguidelines.html">HN’s guidelines</a>: 
</p>
<blockquote>
 If your account is less than a year old, please don&#8217;t submit comments saying that HN is turning into Reddit. (It&#8217;s a common semi-noob illusion.).
</blockquote>
<p>
  However, Mr Curtis has been on HN for <a href="http://news.ycombinator.com/user?id=dcurtis">over five years</a>, and is certainly not subject to the &#8216;common semi-noob illusion&#8217;. Is HN getting worse then?
</p>

<p>
I suspect that when HN started only those that were most passionate about hacking were familiar with HN and would take the time to comment on it. As time went on the popularity of both Y Combinator and HN may have resulted in the level of discourse regressing to the mean. That&#8217;s not to say that there aren&#8217;t still intelligent comments, in fact I&#8217;d argue that there are more intelligent comments than there were 4 or 5 years ago. However, people tend to remember the unintelligent comments more, especially when those comments contain opinions that differ from their own or originate from non-experts.
</p>

<p>
If Digg, Reddit and Hacker News are no longer the best places for discussion how can we create a place that is? While there ought to be many ways to encourage scholarly discussion, and discourage idiotic comments, I want to explore several ideas.
</p>

<h2>Exclusivity</h2>
<p>
In the early stages Digg, Reddit and Hacker News were implicitly exclusive. They didn’t discourage people from joining, but their initial lack of popularity acted as a filter to those who were technically savvy and within certain social networks. Once the exclusivity vanished the communities became diluted. <a href="http://forrst.com">Forrst</a> is explicitly exclusive and is by invitation only. Does Forrst&#8217;s exclusivity lead to a stronger community? To reiterate, is exclusivity a necessity in keeping a social news site strong and viable?
</p>
<h2>Experts</h2>
<p>
I enjoy when an article pops up on HN about physics or biology and several graduate students in those fields provide intelligent comments. Is there a way to officially denote that someone is an expert in a field and automatically give their comments more weight? In very esoteric subjects it isn&#8217;t necessary, the complexity of the subject reduces &#8220;average&#8221; comments. However, in simpler subjects, <a href="http://en.wikipedia.org/wiki/Parkinson's_Law_of_Triviality">bikeshedding</a> becomes an issue. Could bikeshedding be prevented by weighting comments based on the user&#8217;s past comments? For instance, if an individual has been voted up when discussing physics, perhaps future comments on physics should be algorithmically voted up.
</p>

<h2>Focus</h2>
<p>
One thing I really appreciate about HN is the variety of content. However, I can’t help but wonder if a social news site restricted the content to just a specific topic if that would both decrease the probability that the content, and discussion, become watered down? Forrst focuses on design and development, has their focus helped them? Reddit has addressed this issue with subreddits, but the result seems to be many hardly used subreddits. I think focus is important, but at the same time I like being exposed to new topics, can the those two wishes be balanced?
</p>
<h2>Conclusions</h2>
<p>
There is no magic bullet for maintaining the quality of a social news site, but there are a collection of concepts that may help. It would be interesting to A/B test some of those ideas. One could imagine creating several social news websites for different topics and making some exclusive and some not, or altering other variables and see which succeed. What do you think is important in a social news site?
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/08/scraping-web-pages-with-jquery-nodejs-and-jsdom/">Scraping Web Pages With jQuery, Node.js and Jsdom</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-08T00:00:00-05:00" pubdate data-updated="true">Mar 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
I always found it odd that accessing DOM elements with Ruby, or Python, wasn&#8217;t as easy as it was with jQuery. Many HTML parsing libraries employ Simple API for XML (SAX) that can handle extremely large XML documents, but is cumbersome and adds complexity. Other parsing libraries use XML Path Language (XPath), which is conceptually simpler than SAX, but still more of an effort than jQuery. I was pleasantly surprised to discover that it&#8217;s possible to use jQuery to parse web pages with Node.js. This is accomplished by using <a href="https://github.com/tmpvar/jsdom">jsdom, &#8220;a javascript implementation of the W3C DOM&#8221;</a>.
</p>

<h2>jQuery and jsdom</h2>
<p>
Using jsdom you can specify a local file, or url, and jsdom will return the <code>window</code> object for that document. Additionally, JavaScript can be inserted into the document; in our case we&#8217;re inserting the jQuery library. In the example below all the links from the Hacker News front page are logged to the console.
</p>

<figure class='code'><figcaption><span>Scraping Links From Hacker News</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">jsdom</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jsdom&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fs</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">jquery</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">&quot;./jquery-1.7.1.min.js&quot;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">jsdom</span><span class="p">.</span><span class="nx">env</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">html</span><span class="o">:</span> <span class="s1">&#39;http://news.ycombinator.com/&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">src</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="nx">jquery</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">$</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Making Scraping More Robust</h2>
<p>
  Unfortunately there are few common bugs that I ran into when scraping content with jQuery and jsdom. Specifically there are two issues, that aren&#8217;t necessarily specific to jsdom, that are worth watching out for. 
</p>

<h3>jQuery Return Values</h3>
<p>
  The first issue are return values from jQuery function calls. Extra attention has to be paid to return values. Applying a method to <code>undefined</code> will crash a program, a problem that can be especially apparent in DOM parsing. Consider the example below:
</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)[</span><span class="mi">7</span><span class="p">]).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  If there are 8, or more, links on a page the 8th link will be returned and its href attribute will be split into an array. However, if there are less than 8 the <code>attr('href')</code> will return <code>undefined</code> and calling <code>split()</code> on it will crash the program. Since HTML pages aren&#8217;t as structured as API responses, its important not to assume too much and always check return values.
</p>

<h3>Web Page Errors</h3>
<p>
  It&#8217;s entirely possible that the url passed to jsdom returns an error. If the error is temporary, your scraper might miss out on important information. This issue can be mitigated by recursively retrying the url, like the example below:
</p>

<figure class='code'><figcaption><span>Managing Errors</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">getLinks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">retries</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">retries</span> <span class="o">===</span> <span class="mi">3</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">retries</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">jsdom</span><span class="p">.</span><span class="nx">env</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">html</span><span class="o">:</span> <span class="s1">&#39;http://news.ycombinator.com/&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">src</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="nx">jquery</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">errors</span><span class="p">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">getLinks</span><span class="p">(</span><span class="nx">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">$</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
With the above approach, if errors are encountered <code>getLinks</code> will be called recursively with a larger <code>retries</code> value. On the 3rd retry the function will return. If you wanted to go further you could wrap the recursive call in <code>setTimeout</code> to ensure that the recursive web request was not made immediately after the error was encountered.
</p>

<h2>Conclusions</h2>
<p>
  Parsing web pages with jQuery on the server is a much more natural experience for developers already accustomed to using jQuery in the client. However, prior to scraping it&#8217;s worth checking if the site 1) allows scraping and 2) does not already have an API. Consuming a JSON API would be even easy than scraping and parsing!
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/01/why-riak-and-nodejs-make-a-great-pair/">Why Riak and Node.js Make a Great Pair</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-01T00:00:00-05:00" pubdate data-updated="true">Mar 1<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
In the last few years there has been a proliferation of noSQL databases. Searching on Google for <code>site:news.ycombinator.com nosql</code> yields over 2,500 hits, many of which include include posts asking when you&#8217;d want to use a noSQL database. If you&#8217;re used to a relational database it might seem like an unnecessary burden to learn another database paradigm, but there&#8217;s one open source noSQL database that I think is not only worth the burden, but is a perfect fit for Node.js development: <a href=”http://wiki.basho.com/What-is-Riak%3F.html”>Riak (pronounced &#8220;REE-ack&#8221;)</a>. 
</p>

<h2>Why is Riak a Good Fit with JavaScript and Node.js?</h2>

<p>
<a href="http://riakjs.org/">Riak-js</a> makes storing JavaScript objects easy. There is no need to <code>JSON.stringify()</code> a JavaScript object when saving it, or applying <code>JSON.parse()</code> when retrieving. 
</p>

<figure class='code'><figcaption><span>Riak and Node.js Basics</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;riak-js&#39;</span><span class="p">).</span><span class="nx">getClient</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">17</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
</span><span class='line'>            <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;a blog post&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;A blog post about Riak&#39;</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">post</span><span class="p">);</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">meta</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="cm">/* prints</span>
</span><span class='line'><span class="cm">{ id: 17,</span>
</span><span class='line'><span class="cm">  date: &#39;2012-02-29T18:26:44.400Z&#39;,</span>
</span><span class='line'><span class="cm">  title: &#39;a blog post&#39;,</span>
</span><span class='line'><span class="cm">  body: &#39;A blog post about Riak&#39; }</span>
</span><span class='line'><span class="cm">*/</span>
</span></code></pre></td></tr></table></div></figure>

<p>
In the above example, a riak-js client is created and a post object is created. The post object is saved into the &#8216;posts&#8217; bucket, with its id as its key. To retrieve the post, the bucket and key are referenced. 
</p>

<p>
Using JavaScript in the client, and the server are nice, and being able to easily save JavaScript objects is even better. Not having to switch between languages would certainly reduce annoying syntactic problems. This would also allow you to write the entire stack in JavaScript, CoffeeScript or ClojureScript, giving you several programming paradigms to choose from.  
</p>

<p>
If you decided to use <A href="http://andyet.net/blog/2011/feb/15/re-using-backbonejs-models-on-the-server-with-node/">Backbone.js on the server</a>, calling <code>toJSON()</code> on a Backbone model would allow you to easily store the model in the Riak. 
</p>

<h2>Why Riak?</h2>

<p>
At this point you might be wondering why you’d want to use Riak when CouchDB also has a JavaScript interface and can do some of the above. As Damien Katz, the creator of CouchDB has pointed out, <a href="http://damienkatz.net/2012/01/why_couchbase.html">CouchDB is slow and can&#8217;t &#8220;scale-out on it&#8217;s own&#8221;</a>.  In contrast, Riak was built for replication and scaling out. In fact, people at Basho, the company behind Riak, <a href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2010-April/000876.html">indicate that adding new nodes actually increases throughput</a>.
</p>

<h2>Additional Features of Riak</h2>
<p>
Saving JavaScript objects and easy scaling are both good fits with node.js but Riak has some additional features, such as buckets and links, that make retrieval convenient. With buckets the following functions become possible:
</p>

<figure class='code'><figcaption><span>Riak Buckets</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Get all the posts within the posts bucket</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">getAll</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Get all the posts with the title ===  &#39;a blog post&#39; </span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">getAlll</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">where</span><span class="o">:</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;a blog post&#39;</span> <span class="p">}});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Get the number of posts</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p>
Another interesting property of Riak, is it’s concepts of links. A link establishes a &#8220;one-way relationships between objects in Riak&#8221;.  For instance, say we wanted to link similar posts the following would do:
</p>

<figure class='code'><figcaption><span>Riak Links</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">aNewPost</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">date</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
</span><span class='line'>                <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;a second blog post&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;blog post about Riak part 2&#39;</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Save the second post, with a link to the first post</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">aNewPost</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">aNewPost</span><span class="p">,</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">links</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span><span class="nx">bucket</span><span class="o">:</span> <span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="o">:</span> <span class="mi">17</span> <span class="p">}</span> <span class="p">]});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="s1">&#39;18&#39;</span><span class="p">,</span> <span class="p">[{</span><span class="nx">bucket</span><span class="o">:</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span><span class="nx">tag</span><span class="o">:</span><span class="s1">&#39;_&#39;</span><span class="p">}]);</span>
</span><span class='line'><span class="c1">// db.walk, traverses object 18&#39;s links, </span>
</span><span class='line'><span class="c1">// which happens to be post 17, and returns them.</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Conclusions</h2>

<p>
While the above assessment is pretty rosey, Riak shouldn’t be the only database in your toolbox. Redis’ pub/sub and sorted sets are unmatched in Riak. If you’re running <a href="http://labs.linkfluence.net/nosql/2011/03/07/moving_from_couchdb_to_riak.html">map/reduce over large datasets, you’re likely better off using Hadoop</a>. Conversely if your already well-versed in SQL, and your data is relational, using Postgresql is probably a better fit. Despite those caveats being able to easily scale your database, and save JavaScript objects, is a pretty compelling reason to use Riak with Node.js
</p>

<h2>Further Riak and Node.js Reading</h2>
<ul>
<li><a href="http://www.slideshare.net/seancribbs/riak-with-nodejs">Riak with Node.js</a></li>
<li><a href="http://blogs.digitar.com/jjww/2011/03/riak-vs-couchdb-for-storing-100000-coupons/">Riak vs Couchdb for storing 100000 Coupons</a></li>
<li><a href="http://labs.linkfluence.net/nosql/2011/03/07/moving_from_couchdb_to_riak.html">Moving from Couchdb to Riak</a></li>
<li><a href="http://siculars.posterous.com/paginating-with-riak">Pagination with Riak</a></li>
</ul></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/25/adding_real-time_to_rails_with_socket.IO_nodejs_and_backbonejs_with_demo/">Adding Real-Time to Rails With Socket.IO, Node.js and Backbone.js (With Demo)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-25T00:00:00-05:00" pubdate data-updated="true">Feb 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
  <a href="http://node-chatty.herokuapp.com/chatty" target="_blank"><img src="/images/chatty-screen.png"></a>
</p>
<p>
  Despite the <a href="http://gilesbowkett.blogspot.in/2012/02/rails-went-off-rails-why-im-rebuilding.html">recent distaste for Rails</a>, I still think its a nice framework for developing websites (e.g. devise &amp; active record). However, if you want real-time communication Socket.IO and Node.js seem to be the best options. If you already have an existing Rails application porting the entire application to Node.js is likely not on option. Fortunately, it is relatively easy to use Rails to serve your client-side Socket.IO web application, while Node.js and Socket.IO are used for real-time communication. The primary goal of this article is to show one method of integrating a real-time application, that is slightly more complex than a todo app, with Rails. Thus, I created Chatty, a simple chat room web application that allows a user to see all the messages in the chat room, or filter the messages by user. <a href="http://twitter.github.com/bootstrap/index.html">Twitter&#8217;s Bootstrap</a> was used for the CSS and modal dialogue. 
</p>
<p>
<a class="github" href="https://github.com/liamks/Chatty"><span></span>Code on Github</a>
</p>
<p>
  Rather than explain the code step-by-step, I&#8217;ll provide a high level overview of:
  <ul>
    <li>File organization</li>
    <li>JavaScript Templates and EJS</li>
    <li>Application Archicture and Publish/Subscribe</li>
    <li>Module Architecture</li>
    <li>Deploying to Heroku</li>
  </ul> 
<p>

<h2>File Organization</h2>
<p>
  The entire client-side Backbone.js application is within <code>app/assets/javascripts</code>. Using a JavaScript manifest file (<code>backboneApp.js</code>) all of the application&#8217;s JavaScript files are specified.
</p>

<figure class='code'><figcaption><span>Manifest file (app/assets/javasripts/bacboneApp.js)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>//= require jquery
</span><span class='line'>//= require bootstrap
</span><span class='line'>//= require underscore
</span><span class='line'>//= require backbone
</span><span class='line'>//= require socket.io
</span><span class='line'>//= require app
</span></code></pre></td></tr></table></div></figure>
<p>
  The Backbone application is within the <code>app</code> folder, which also has a manifest file. The manifest files describe all the JavaScript files that comprise the application. Within the application&#8217;s html file only a single line of code is needed to include the manifest file: <code>=javascript_include_tag "backboneApp"</code> (haml for templating). The actual organization of the files is as follows:
</p>

<figure class='code'><figcaption><span>app/assets</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>javascripts
</span><span class='line'>├── app
</span><span class='line'>│   ├── index.js
</span><span class='line'>│   ├── launch.js.coffee
</span><span class='line'>│   ├── main.js.coffee
</span><span class='line'>│   ├── modules
</span><span class='line'>│   │   ├── index.js
</span><span class='line'>│   │   ├── loadModule.js.coffee
</span><span class='line'>│   │   ├── messageModule.js.coffee
</span><span class='line'>│   │   ├── socketModule.js.coffee
</span><span class='line'>│   │   └── userModule.js.coffee
</span><span class='line'>│   └── templates
</span><span class='line'>│       ├── message.jst.ejs
</span><span class='line'>│       ├── modal.jst.ejs
</span><span class='line'>│       └── user.jst.ejs
</span><span class='line'>├── application.js
</span><span class='line'>├── backboneApp.js
</span><span class='line'>└── backbone_app.js.coffee
</span></code></pre></td></tr></table></div></figure>

<p>
  <code>main.js.coffee</code> is where the app object is defined, while `launch.js.coffee` is called last, after all the files have loaded, to launch the Backbone.js application. Each module, which might contain models, collections and views, are stored within the modules folder. The module structure was modelled after <a href="http://tbranyen.github.com/backbone-boilerplate/">Backbone Boilerplate</a>.
</p>

<h2>JavaScript Templates and EJS</h2>
<p>
  To take full advantage of the asset pipeline it seems as if Sam Stephenson&#8217;s excellent <a href="https://github.com/sstephenson/ruby-ejs">EJS Gem</a> was the most hassle free approach for JavaScript templates. Both the &#8216;ejs&#8217; and &#8216;jst&#8217; extensions are require for the EJS gem to compile the template, and include it within a JavaScript file. Access to the template is done with the global <code>JST</code> object.
</p>

<h2>Application Architecture - Publish/Subscribe</h2>
<p>
  Before creating the application I decided to forgo the use of asynchronous module definition (AMD) and use a publish/subscribe (pub/sub) architecture (<a href="http://addyosmani.com/resources/essentialjsdesignpatterns/book/#detailedobserver">see Addy Osmani&#8217;s description of Pub/Sub</a>). Specifically, each module is wrapped in an <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">immediately-invoked function expression</a>, and within each module functions can attach themselves to events (subscribe), or trigger events (publish). Using this approach the applcation&#8217;s only global variable is <code>app</code> which contains a copy of Backbone&#8217;s event object. 
</p>
<p>
  To reiterate none of the modules call methods from other modules, all communication occurs with pub/sub. This design pattern was a pleasure to use; adding new functionality often required simply subscribing to events! I found that my code stayed much cleaner than previous attemps with Backbone.js.
</p>

<h2>Module Architecture</h2>
<p>The application is comprised of two types of modules, those that contain Backbone.js code (messageModule, userModule), and one that contains the Socket.IO code (socketModule). If either the messageModule, or the userModule, require content from Socket.IO they subscribe to events that the socketModule trigger. Likewise, Socket.IO messages sent to the server are the result of the socketModule suscribing to events triggered by the messageModule and userModule.
</p>
<p>
  Below is an example module that contains skeleton code for an additional Backbone.js module. The ExampleModule class is used to glue all the Backbone.js objects together. In this case their is only one, the ExampleView, in Chatty&#8217;s MessageModule there are two distinct views instantiated within its MessageModule object. 
</p>
<figure class='code'><figcaption><span>Example Module</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">ExampleModel = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ExampleCollection = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">model: </span><span class="nx">ExampleModel</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># View for a single model</span>
</span><span class='line'><span class="nv">ExampleView = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">render: </span><span class="nf">() -&gt;</span>
</span><span class='line'>    <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span> <span class="nx">app</span><span class="p">.</span><span class="nx">template</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">@$el</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># View for a collection of models</span>
</span><span class='line'><span class="nv">ExamplesView = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span>
</span><span class='line'>  <span class="nv">initialize: </span><span class="nf">() -&gt;</span>
</span><span class='line'>    <span class="vi">@collection = </span><span class="k">new</span> <span class="nx">ExampleCollection</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">@collection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="nx">@addExample</span><span class="p">,</span> <span class="err">@</span>
</span><span class='line'>    <span class="nx">@eventHandlers</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">eventHandlers: </span><span class="nf">() -&gt;</span>
</span><span class='line'>    <span class="c1"># Subscribe to the app-wide event &#39;new-example&#39;. When </span>
</span><span class='line'>    <span class="c1"># the event is called, the call-back function is provided</span>
</span><span class='line'>    <span class="c1"># with an example model, which is then added to the collection.</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;new-example&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">example</span><span class="p">)</span> <span class="o">=&gt;</span>
</span><span class='line'>      <span class="nx">@collection</span><span class="p">.</span><span class="nx">add</span> <span class="nx">example</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">addExample: </span><span class="nf">(example) -&gt;</span>
</span><span class='line'>    <span class="nv">exampleView = </span><span class="k">new</span> <span class="nx">ExampleView</span>
</span><span class='line'>      <span class="nv">model: </span><span class="nx">example</span>
</span><span class='line'>    <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span> <span class="nx">exampleView</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">ExampleModule</span>
</span><span class='line'>  <span class="nv">constructor: </span><span class="nf">() -&gt;</span>
</span><span class='line'>    <span class="vi">@examplesView = </span><span class="k">new</span> <span class="nx">ExamplesView</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">new</span> <span class="nx">ExampleView</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Deploying Node.js and Rails App to Heroku</h2>
<h3>Deploying the Node.js server</h3>

<p>
  Heroku requires the following code to create the Socket.IO server and listen for connections (note that Heroku doesn&#8217;t support websockets):
<p>
<figure class='code'><figcaption><span>Socket.IO server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">io</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;transports&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;xhr-polling&quot;</span><span class="p">]);</span>
</span><span class='line'>  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;polling duration&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;close timeout&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;log level&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">5001</span><span class="p">;</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  Unfortunately, Heroku&#8217;s documentation only contains fragments of the above code. The above code, along with deploying instructions, is posted across several pages: <a href="http://devcenter.heroku.com/articles/node-js">getting started with Node.js on Heroku/Cedar</a> and <a href="http://devcenter.heroku.com/articles/using-socket-io-with-node-js-on-heroku">using Socket.IO with Node.js on Heroku</a>. The `close timeout` option was added since the default 25 seconds made the chat app seem buggy (a user would log out but other users would seem them logged in for 25 seconds).
</p>

<h3>Deploying the Rails app</h3>
<p>
  Deploying a Rails application is relatively well documented, but I thought I&#8217;d provide a few additional tips.
</p>
<p>
  The URL for the production and development Socket.IO server differ. To accommodate this the Backbone.js app makes an Ajax request to the Rails app and gets the URL of the Socket.IO server along with a unique id for the current user. The Rails app can serve a different Socket.IO URL depending on whether it is currently in production or development.
</p>
<p>
  The other thing that might be new for nacent Rail&#8217;s developers is the inclusion of the <code>response.headers</code> code in the show method, this tells the browser to cache the Backbone.js app for 25,300 seconds.
</p>
<figure class='code'><figcaption><span>Controller associated with Backbone.js App</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">BackboneAppController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">layout</span> <span class="s1">&#39;backboneApp&#39;</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;public, max-age=25300&#39;</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">user_info</span>
</span><span class='line'>    <span class="n">respond_with</span><span class="p">({</span>
</span><span class='line'>        <span class="s1">&#39;uuid&#39;</span> <span class="o">=&gt;</span> <span class="no">UUIDTools</span><span class="o">::</span><span class="no">UUID</span><span class="o">.</span><span class="n">random_create</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;socketURL&#39;</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="o">.</span><span class="n">get_socket_url</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_socket_url</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span> <span class="p">?</span> <span class="s2">&quot;http://chatty-server.herokuapp.com/&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://0.0.0.0:5001&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  In order for Heroku to manage the asset pipeline your application must be <a href="http://devcenter.heroku.com/articles/rails3">deployed to Heroku Cedar&#8217;s stack</a>. Unfortunately the Cedar stack doesn&#8217;t include Varnish caching, requiring you to enable caching via <a href="http://devcenter.heroku.com/articles/memcache#deploying_to_heroku">memcache and the dalli gem</a>. I found that deploying a new version would not necessarily clear the cache and and I had to do it manually (connect to console: <code>heroku run console</code>):
</p>

<figure class='code'><figcaption><span>Clearing the cache</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dc</span> <span class="o">=</span> <span class="no">Dalli</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;localhost:11211&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">dc</span><span class="o">.</span><span class="n">flush_all</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Final Thoughts</h2>
<p>Relying entirely on pub/sub to communicate between modules worked really well in this application, but I wonder if it would scale to a larger application? I&#8217;d also be curious to know how other developers are combining Backbone apps with Rails, I suspect there are a number of ways to do it.</p>

<p>
<a class="github" href="https://github.com/liamks/Chatty"><span></span>Code on Github</a>
</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  <div class='social'>

  <a id="twitter" href="https://twitter.com/liamkaufman"><span></span>@liamkaufman</a>
  <a id="github" href="https://github.com/liamks"><span></span>@liamks</a>
  <a id="linked-in" href="http://www.linkedin.com/pub/liam-kaufman/1b/7b4/2a4"><span></span>Liam Kaufman</a> 
</div>


  <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/11/21/why-you-should-be-nice-to-your-customers/">Why You Should Be Nice To Your Customers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/09/stripe-would-be-perfect-if/">Stripe Would Be Perfect If&#8230;</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/09/common-javascript-errors/">Common JavaScript Errors</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/04/redis-and-relational-data/">Redis and Relational Data</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/21/adding-authentication-waiting-lists-and-sign-ups-to-and-express-app-using-drawbridge-and-redis/">Adding Authentication, Waiting Lists and Sign Ups to an Express App Using Drawbridge.js and Redis</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("liamkaufman", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/liamkaufman">@liamkaufman</a></p>
  
</section>








</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Liam Kaufman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'liamkaufman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





    

<script type="text/javascript">
      var disqus_shortname = 'liamkaufman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  <script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
  </script>
</body>
</html>
