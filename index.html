
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Liam Kaufman</title>
  <meta name="author" content="Liam Kaufman">

  
  <meta name="description" content="After rewriting Understoodit several times I’ve spent a lot of time thinking about building real-time web applications. While I elected to rewrite &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://liamkaufman.com">

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/liamkaufman/uHFr" rel="alternate" title="Liam Kaufman" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1004776-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
 
  <h1><a href="/">Liam Kaufman</a></h1>
  
    <h2>Software Developer and Entrepreneur</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/liamkaufman/uHFr" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:liamkaufman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about.html">About</a></li>
  <li><a href="/projects.html">Projects</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/27/adding-real-time-to-a-restful-rails-app/">Adding Real-Time to a RESTful Rails App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-27T00:00:00-05:00" pubdate data-updated="true">Feb 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
  After rewriting <a href="http://understoodit.com">Understoodit</a> several times I’ve spent a lot of time thinking about building real-time web applications. While I elected to rewrite 100% of Understoodit in Node, there are many existing Rails and Sinatra applications that can’t be completely rewritten, but could still benefit with the addition of real-time updates. The tutorial below starts with a traditional web-app written in Backbone and Ruby on Rails (RoR). Of course the modifications could easily be applied to any (Backbone|Angular|Ember) and (Rails|Sinatra|Django|Pylons) app.
</p>
<p>
  Between the overview below, and the <a href="https://github.com/liamks/rails-realtime">code on GitHub</a>, you should be able to follow along and, in less than 50 lines of code, add real-time updates to your Rails app.
</p>
<p>
<a class="github" href="https://github.com/liamks/rails-realtime"><span></span>Adding Real-Time on Github</a>
</p>
<h2>Starting Point</h2>
<p>
In a traditional web app if a user creates a new model other users must refresh their page to see that content. Alternatively, you could poll the server every 30 second and refetch all the content. With both approaches you end up fetching all the content, and in the first case the markup as well. 
</p>

<p>
<img class="center" src="/images/rails-realtime-rest.png" alt="Traditional RESTful Rails app">
</p>

<p>
In Figure 1, User 1 creates a new book, but User 2 will not see that new book unless they refresh their page. 
</p>

<h2>Adding Real-Time With Redis And Socket.IO</h2>
<p>
When User 1 creates a new book, we’d like that new book to be pushed to User 2 in real-time. I’m going to cover one method that requires only a few modifications to your existing app and uses Redis, Node and Socket.IO. 
</p>

<h2>How It Will Work</h2>

<img class="center" src="/images/rails-realtime-with-rt.png" alt="Traditional RESTful Rails app with Real-Time">
<ol>
  <li>When User 1 creates a new book, an &#8220;after_create&#8221; callback publishes that new book to Redis on the &#8220;rt-change&#8221; channel.</li>
  <li>On the Node server, each client subscribing to &#8220;rt-change&#8221; receives that new book.</li>
  <li>The new book is pushed to the client using Socket.IO.</li>
  <li>Within the browser, Socket.IO receives that new book and &#8220;publishes&#8221; that change to our Backbone.js App.</li>
  <li>The Backbone.js books collection, listening for changes to books, adds the new book to itself.</li>
</ol>

<p>
The advantage of this approach is that it only requires tiny modifications to a Rails&#8217; model, and if your Node server crashes, your application will work as it always has (without real-time). Thus, I’d consider this a real-time enhancement that gracefully degrades to a conventional Rails RESTful web app.
</p>

<h2>Socket.IO Connection</h2>
<p>
  First, ensure that <code>socket.io.js</code> has been added to <code>lib/assets/javascripts</code>, and referenced in app/assets/javascripts/application.js. In the web app create a new module, called realtime, that includes the Socket.IO connection code. When the application initializes it calls <code>app.realtime.connect()</code> to setup the Socket.IO connection.
</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">realtime</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">connect</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;http://0.0.0.0:5001&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;rt-change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
</span><span class='line'>      <span class="c1">// publish the change on the client side, the channel == the resource</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Node Server &amp; Pub/Sub</h2>
<p>
  In the root of the Rails app create a new folder called &#8216;realtime&#8217;, where the Node server will reside. Don&#8217;t forget to create a <code>package.json</code> file and include socket.io, and redis in the dependencies. Finally, remember to run <code>npm install</code>.
</p>

<figure class='code'><figcaption><span>realtime/realtime-server.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">5001</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">).</span><span class="nx">createClient</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">redis</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;rt-change&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">redis</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;rt-change&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Rails Models</h2>
<p>
  Assuming you have Redis installed, add redis to your Gemfile. Next, create a file called <code>redis.rb</code> in your initializers with the following content:
</p>
<figure class='code'><figcaption><span>config/initializers/redis.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#make sure redis has been added to your Gemfile</span>
</span><span class='line'><span class="vg">$redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="ss">:port</span><span class="o">=&gt;</span> <span class="mi">6379</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>
  The Rails app now has access to Redis through the <code>$redis</code> global variable. Below, we publish changes to Redis whenever a model is created, updated or destroyed. Changes are published to &#8220;rt-change&#8221;, which our Node.js connections are listening to (see above).
</p>
<figure class='code'><figcaption><span>app/models/book.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:num_pages</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'>  <span class="n">after_create</span> <span class="p">{</span><span class="o">|</span><span class="n">book</span><span class="o">|</span> <span class="n">book</span><span class="o">.</span><span class="n">message</span> <span class="s1">&#39;create&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">after_update</span> <span class="p">{</span><span class="o">|</span><span class="n">book</span><span class="o">|</span> <span class="n">book</span><span class="o">.</span><span class="n">message</span> <span class="s1">&#39;update&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">after_destroy</span> <span class="p">{</span><span class="o">|</span><span class="n">book</span><span class="o">|</span> <span class="n">book</span><span class="o">.</span><span class="n">message</span> <span class="s1">&#39;destroy&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">message</span> <span class="n">action</span>
</span><span class='line'>    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span> <span class="n">resource</span><span class="p">:</span> <span class="s1">&#39;books&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">action</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
</span><span class='line'>            <span class="nb">id</span><span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>            <span class="n">obj</span><span class="p">:</span> <span class="nb">self</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="vg">$redis</span><span class="o">.</span><span class="n">publish</span> <span class="s1">&#39;rt-change&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Listen For Changes in The Backbone App</h2>
<p>
  In the Books Collection, we add the code to both listen for &#8216;books&#8217; events and the handler to handle those events. For create, we simply add the new object (obj) to the collection. For update we update the existing model, while for destroy we remove the object from the collection.
</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">Books</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">model</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Book</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">url</span> <span class="o">:</span> <span class="s1">&#39;/books&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;books&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handle_change</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">handle_change</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">model</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">action</span><span class="p">){</span>
</span><span class='line'>      <span class="k">case</span> <span class="s1">&#39;create&#39;</span><span class="o">:</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="s1">&#39;update&#39;</span><span class="o">:</span>
</span><span class='line'>        <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">case</span> <span class="s1">&#39;destroy&#39;</span><span class="o">:</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">obj</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Caveats</h2>
<p>
  In production there are many edge cases to consider. For instance, if someone views your app on their mobile phone and then puts the phone in their pocket, the screen saver goes on and Socket.IO will disconnect. When the user takes the phone out of their pocket, and views the app, Socket.IO will reconnect. However, during the period of disconnection the data in the client-side app may have become out-of-date. An easy fix is just to fetch the data on reconnect. With lots of connections, or lots of data, fetching everything becomes problematic and requires a more clever method for fetching data (e.g. just fetch the new, or changed, data).
</p>
<p>
  Another issue is if two people are editing the same item, and if person 1 clicks save that will replace what person 2 is editing. To solve this you can present person 2 with a message saying that the book they are editing has been updated by someone else and prevent the version of the book they are editing from being replaced. This isn&#8217;t an ideal solution, but would be fine if the chances of two people editing the same model were minimal. 
</p>
<p>
  In the code above there is only one channel &#8216;rt-change&#8217;, meaning every connected client will get every real-time change. You may want to scope your channels by user (e.g. rt-change/[USERID]). Furthermore, you&#8217;d want to create one redis client for every Socket.IO connection (currently there&#8217;s one redis client for all connections). In other words the <code>.createClient()</code>, and <code>redis.subscribe('...')</code>, would have to take place within the Socket.IO &#8216;connection&#8217; callback (after line 6 above).
</p>

<h2>Alternatives To The Above</h2>
<h3>SockJS</h3>
<p>
  Socket.IO could be swapped for <a href="https://github.com/sockjs/sockjs-client">SockJS</a>, which uses a similar API to websockets. I&#8217;ve heard from several individuals that it&#8217;s significantly more stable than the current version of Socket.IO and it&#8217;s currently <a href="https://github.com/meteor/meteor/tree/master/packages/stream">used by Meteor</a>.
</p>

<h3>Engine.IO</h3>
<p>
  Guillermo Rauch, the creator of Socket.IO, has publically stated that Socket.IO&#8217;s approach of starting with websockets and falling back to polling <a href="http://www.devthought.com/2012/07/07/the-realtime-engine/">creates issues</a>. As result, he&#8217;s been working on Engine.IO, which will power Socket.IO version 1.0, and should provide a much more stable experience. I suspect Socket.IO, v1.0, will be released in the next few months.
</p>

<h3>Rails 4.0</h3>
<p>
  Rails 4.0, <a href="http://weblog.rubyonrails.org/2013/2/25/Rails-4-0-beta1/">which is due to be released soon</a>, will include <a href="http://tenderlovemaking.com/2012/07/30/is-it-live.html">streaming</a>. Using a combination of Rails 4 streaming, and Puma, you could potentially remove Node and Socket.IO, and use Rails for real-time. Of course, you&#8217;d have to take care of some of what Socket.IO does such as reconnects and heart-beats.
</p>

<h3>RabbitMQ/ZeroMQ</h3>
<p>
  Redis&#8217; Pub/Sub functionality could be replaced by either RabbitMQ or ZeroMQ. I ended up using Redis, since I was using it for caching, and it has an extremely simple API for pub/sub. While RabbitMQ and ZeroMQ appear more complex, they do offer many more features for messaging.
</p>

<h3>Commercial Options</h3>
<p>
  If you&#8217;re not keen on tinkering with Node, or waiting for Rails 4, there are commercial options such as <a href="http://pusher.com/">Pusher</a> and <a href="http://www.pubnub.com/">PubNub</a>, that deal with real-time connections for you. While both options can be pricey, especially with many concurrent connections, they do save you the hassle of building the infrastructure yourself.
</p>

<h2>Conclusions</h2>
<p>
  Adding real-time updates to your Ruby on Rails RESTful app has never been easier. Over the next few months Rails 4, or Socket.IO v1.0, will make the process even more painless. As Google&#8217;s services make users more accustomed to real-time updates, it becomes even more important to provide a similar experience in your webapps. 
</p>

<p>
<a class="github" href="https://github.com/liamks/rails-realtime"><span></span>Adding Real-Time on Github</a>
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/08/three-important-conversion-metrics-you-should-watch/">Three Important Conversion Metrics You Should Watch</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-08T00:00:00-05:00" pubdate data-updated="true">Feb 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
You’ve created an <a href="http://liamkaufman.com/blog/2013/01/22/making-software-people-want-before-launching/">app that your beta testers use</a> and <a href="http://liamkaufman.com/blog/2013/01/30/are-you-ready-to-launch/">your launch was a huge success</a>. Every day the number of registered users increases and you feel like you’re making progress and moving closer to your goals. 
</p>
<p>
It would be a mistake to hunker down and focus singularly on hammering out new features. Now that you’ve launched you have significantly more people visiting your homepage, creating accounts and using your app. You have much more data to help you prioritize what to do next. 
</p>
<p>
I’ll focus on three important metrics that are extremely important and especially so after launching. These metrics are all conversion metrics and include 1) vistors creating an account, 2) becoming an active user and 3) becoming a paying user. While there are exceptions, the order is important: a user can’t become an active user without creating an account. Likewise, paying users are most likely active users. 
</p>

<h2>Create An Account</h2>

<p><strong>What percent of visitors create accounts?</strong> There many variables that will influence the percent of visitors that create an account and they include:</p>

<h3>Relevant Keywords</h3> 
<p>Maybe visitors are arriving at your site searching for something else. If that’s the case you might have a high bounce rate (e.g. users coming to your site and immediately leaving). To fix this issue investigate ways to improve your SEO and ensure that your keywords are relevant to your product.</p>

<h3>Clear Selling Point</h3> 
<p>Have you made it as clear as possible why your product is needed? Ask colleagues unfamiliar with your product to evaluate you&#8217;re site&#8217;s copy and it&#8217;s clarity.</p>

<h3>Call-to-Action Button</h3>
<p>Have you made it obvious how they can create an account? To test this you can use a service like Optimizely to A/B test different variants of your front page and your call-to-action button.</p>

<h3>Pricing</h3> 
<p>Maybe your pricing page is too complicated, or your prices are too high, and as a result users don’t even bother creating an account. This is an issue that you should look into before you launch. Ideally you should speak with an appropriate number of potential customers to figure out if your price is within a reasonable range.</p>


<h2>Become An Active User</h2>

<p>
<strong>What percent of users become active users (e.g. use your app every day/week)?</strong> Your definition of an active user is dependent on your service. If you’re creating a new email app, or a social network, an active user might be someone who uses your app multiple times per day. If you&#8217;re creating a tax app, an active user might be someone who uses it once a year for a week. In order to measure active users first you must define who they are (duh!). 
</p>
<p>
<strong>Problem:</strong> users create an account and then never use your app again. It could be that you have a very interesting idea, but your implementation is off. Likewise you could be attracting a lot of curious users that have no intention of actually using your app, but just want to see what the fuss is about.
</p>
<p>
I’d recommend following-up on a user if they haven’t used your app in a week after registering. Ask them why they didn’t end up using it, and what *one* feature they’d need to use it. Your response rate will likely be between 5 - 10% but hopefully that should be enough to pick up trends. If possible I’d automate this step to ensure that emails are sent out consistently and you don’t waste your time sending out copy and pasted emails.
</p>
<p>
<strong>Problem:</strong> they use your app for a couple of weeks and then never use it again. While still bad, at least you have more data to work with. Check your database and determine what parts of your app they were using. For an email app, were they sending emails, but not creating contacts? Maybe creating contacts was too tricky and they gave up and stopped using your app. 
</p>
<p>
Analyze your data carefully and see if you can pick patterns that can point you to areas that need to be improved. 
Alternatively there could be temporal patterns, for instance, people who only use your app once a week quickly stop using it relative to those that use it several times a week. Finding patterns of use and comparing active users to non active users can shed further light on potential problems.
</p>

<h2>Become A Paying User</h2>
<p>
<strong>What percent of your active users become paying users?</strong> Comparing patterns of use between users who&#8217;ve converted, and those who have not, in the same cohort is useful for elucidating causality in conversions.
</p>
<p>
Unlike the previous step you should have much more data to conduct your analysis. More data means that it should be easier to find statistically significant patterns, but it may be more challenging and time consuming to do analysis. I’d recommend generating fewer than five hypotheses before you start your analysis. This will both limit the complexiy of analysis and reduce the <a href="http://en.wikipedia.org/wiki/Multiple_comparisons">multiple comparison problem</a> (e.g. with enough comparisons you’re bound to get significant differences that are due to chance alone).
</p>

<h2>Conclusions</h2>
<p>
Analyzing what your users are doing, why some are creating accounts, why some are becoming paid users and why others are not is extremely important. If you love coding, and adding new features, it can seem like a big time waster, however, doing the above will help you prioritize better.
</p>
<p>
 Although I haven’t tried either myself both Kissmetrics or Google Analytics’s Conversion feature should help you with the above. It’s crucial to be able to quickly determine why some users never become active, or never become paying users. Use hypotheses, data and outcomes to determine how to spend your time efficiently. Time is something you have little of, use it wisely.
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/30/are-you-ready-to-launch/">Are You Ready to Launch?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-30T00:00:00-05:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
  <strong>Last Week</strong>: <a href="http://liamkaufman.com/blog/2013/01/22/making-software-people-want-before-launching/">Before Launching, Build Software People Use</a>
</p>
<p>
You’ve created a product that people want to use, and now you’re eager to launch. From my experiences launching <a href="https://understoodit.com">Understoodit</a>, in May 2012, I’ve compiled a set of steps that helped Understoodit get on several big sites including <a href="http://techcrunch.com/2012/05/02/understoodit-lets-students-voice-their-confusion-without-having-to-raise-their-hands/">TechCrunch</a>, <a href="http://www.thestar.com/news/gta/article/1173277--don-t-get-what-the-prof-s-talking-about-there-s-an-app-for-that">Toronto Star</a>, and <a href="http://betakit.com/2012/05/03/understoodit-helps-confused-students-in-the-classroom">BetaKit</a>. If you have a large budget hiring a PR firm might be your best bet, otherwise the steps below will help you get started.
</p>

<h2>A Unique Angle</h2>
<p>
If you’re going to catch people’s attention in an app saturated environment, it’s important to communicate what&#8217;s unique about your app. If you’ve created a todo app, is it for Doctors, Engineers or does it something truly unique? If you can’t figure out why your product is unique it&#8217;s going to be a tough sell and it will certainly make it more difficult to get the press interested on your launch day. 
</p>
<p>
The unique angle for Understoodit was focusing on its confusion feedback feature (students can click confused, and in real-time the teacher can see what percentage of students are confused). If I had said Understoodit was a &#8220;classroom response system&#8221;, I would have had a much harder time competing for attention.
</p>
<h2>Press Release</h2>
<p>
An important step in preparing for a launch is crafting a press release. If you’ve never written one, or you aren’t a strong writer, I’d recommend hiring someone to write it with you (<a href="http://www.linkedin.com/pub/vicki-so/29/350/903">Vicki So</a> helped me). 
</p>
<p>
My familiarity with Understoodit made it difficult to objectively write about it. When you’re focused on the technical side of your product it can be easy to loose focus on what’s important to prospective users. By asking good questions, Vicki was able to tease out of me what was important about Understoodit and why educators might be interested. She was able to turn a product launch into an interesting story about how I started Understoodit. 
</p>
<p>
Reporters read many press releases each day, make sure yours is interesting, <a href="http://www.markevanstech.com/2013/01/29/why-startups-need-to-be-great-storytellers/">tells a story</a>, and is well crafted.
</p>

<h2>Reporters &amp; Bloggers</h2>
<p>
One of the most important tips Vicki gave me was: send the press release to a specific reporter, not a newspaper or website in general. A reporter who covers education is potentially more interested in Understoodit than the average person handling general enquiries. In preparation for launch I made a long list of reporters that cover education, and on launch day I emailed each of them a quick note with a press release attached. I’d also recommend adding reporters who cover small business and startups to your list, they may also be interested. 
</p>
<p>
In addition to reporters, I contacted a couple local tech bloggers and asked if I could give them a face-to-face demo. This approached allowed me to pitch a reporter at BetaKit, a Toronto-based website that covers startups. They ended up doing an <a href="http://betakit.com/2012/05/03/understoodit-helps-confused-students-in-the-classroom">article about Understoodit</a> a day after the launch.
</p>

<h2>Social Media</h2>
<p>
I’m no social media expert, but I can say it played an important role in the early success of Understoodit. Facebook and Twitter were huge sources of traffic, as were social news sites such as Hacker News. Depending on your product’s niche you might have more luck with other social networks such as Pinterest or Instagram. However, for you to have a big impact on sites like Twitter, or Pinterest, it helps to have a lot of followers. Gaining followers takes time and is something you should consider long before you launch. 
</p>

<h2>Friends &amp; Family</h2>
<p>
I owe a lot of Understoodit’s launch success to friends that not only helped me with the press release, but also tweeted, liked and voted up Understoodit on launch day. Friends and family are also critical in getting you over the trough of despair - so be kind to them!
</p>

<h2>Luck</h2>
<p>
No matter how prepared you are there is a strong component of luck to a successful launch. Was your press release the first that a reporter read, or did they read it after reading 5 others? Was there a major news event on the day of your launch? Did a writer on TechCrunch see your launch on Hacker News? All those things are mostly out of your control but can greatly affect your success. Preparation can mitigate some of those issues. For instance, it’s always a good idea to see if there might be any important news events, or tech announcements, that could overshadow your launch. 
</p>

<h2>Conclusions</h2>
<p>
After following the above actions, mixed with a healthy dose of luck, I was on the front page of Hacker News, and later that day on TechCrunch. Over a 24 hour period Understoodit received hundreds of registrations. Ultimately, that initial burst of excitement made it possible to get an article in the Toronto Star and the Chronicle of Higher Education.
</p>
<p>
<strong>Next Week</strong>: I will cover 3 important metrics that you need watch after launching your product.
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/22/making-software-people-want-before-launching/">Before Launching Build Software People Use</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-22T00:00:00-05:00" pubdate data-updated="true">Jan 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
You’re a talented developer and have a great idea for a startup. You’ve read <a href="http://theleanstartup.com/"><em>The Lean Startup</em></a>, you’ve attended entrepreneur events, and you read <a href="http://news.ycombinator.com/"><em>Hacker News</em></a>. At this point you’re confident that you’ll be able to build a compelling product while avoiding common startup mistakes. 
</p>
<p>
Unfortunately, that pretty much summed up my (immodest) perception of myself prior to launching <a href="https://understoodit.com">Understoodit.com</a>. 
</p>
<p>
While the May 2012 launch of Understoodit was more successful than I anticipated, there were certainly things I could have placed more focus on prior to launching. Below I’ve informally divided the pre-launch process into 5 stages:  1) finding customers, 2) the one feature, 3) early beta testing, 4) engaged users, and 5) time to launch.
</p>
<h2>Stage 1: Finding Customers</h2>
<p>
It’s an increasingly common sentiment that you should find potential customers before you start building a product. If you have difficulty finding customers at this stage it may not get easier when you’re coding 12 hours a day. In my experience it’s easier to get help from potential customers at this stage since you aren’t necessarily selling anything yet. At this stage you’re simply doing research and building relationships with potential customers. When contacting professors for Understoodit, I found they were happy to give feedback and provide constructive criticism. If  initially I had tried to sell them something, they may not have been so forthcoming with help and criticism. If all goes well, those first few relationships will turn into paying customers, so be kind and accept their feedback without becoming defensive! 
</p>
<h2>Stage 2: The One Feature</h2>
<p>
Assuming you’ve mastered the previous step, getting feedback will be easy. In fact you’ll likely end up with a laundry list of features. Some features are nice to have, while others will be critical. Unfortunately teasing apart the critical features from the nice-to-haves is not always easy [1]. I’d recommend asking potential users: “If we added only one feature, what would be the most important?” This will force your users to prioritize what they think is the most important feature. A single user may not get this right, but the intuition of multiple users should converge on a single feature. That single feature will become your minimum viable product (MVP). Furthermore, if your users thought that feature was very important, it’s likely that others, in the same demographic, will also think it’s important. 
</p>
<h2>Stage 3: Early Beta Testing</h2>
<p>
At this stage you’ve created an MVP, with one critical feature, and you’re eager to start early beta testing. There is a lot of good advice on user testing online, so I’ll focus on one method that I’ll dub &#8220;passive watching&#8221;. Passive watching involves sitting with potential users and passively watching them create an account, use your app, perform various actions, etc. It’s important not to help them at this point. Rather, what you want to do is see where they’re getting stuck, where they’re getting frustrated, and where things are working smoothly. Don’t be defensive if they dislike the user interface, or its flow, just listen at this stage. After testing with 10 - 20 potential users, you’ll get a very good idea of what needs to be improved, removed and what needs to be added. 
</p>
<h2>Stage 4: Engaged Users?</h2>
<p>
During early beta testing you hopefully received a lot of positive feedback. (And thanks to many who gave me feedback, including readers of this blog.) But don’t conflate positive feedback with engagement. <em>Just because a user says your app is great, it doesn’t guarantee that they will actually use it, let alone pay for it</em>. However, if your early beta testers keep using it, and start telling their friends, then that’s a good sign. On the other hand, if they stop using it, it’s critical to find out why they’re not using it. If you can’t engage your early beta testers (that is, users who’ve invested a lot of time already), it will be difficult to engage new users after launch. This stage is important! So don’t fool yourself into thinking you’ve created a great product unless you have engaged users using your app regularly (self awareness and introspection are important attributes for entreprenuers [2]). If your users aren’t engaged you have to decide whether to go back to early beta testing, pivot, or scrap the idea entirely.
</p>
<h2>Stage 5: Time to launch</h2>
<p>
You’ve built a strong MVP that is used regularly by your beta testers. In turn those testers are telling friends and colleagues about your app. You’ve validated both your idea and your execution and it’s time to launch and grow the number of users. 
</p>
<p>
<strong>Next week</strong> I’ll cover some of my experiences that helped get Understoodit featured on <a href="http://techcrunch.com/2012/05/02/understoodit-lets-students-voice-their-confusion-without-having-to-raise-their-hands/">TechCrunch</a>, <a href="http://news.discovery.com/tech/understoodit-app-120514.html">Discovery.com News</a>, <a href="http://chronicle.com/blogs/wiredcampus/app-tries-to-increase-student-participation-by-simplifying-clicker-technology/37855">The Chronicle of Higher Education</a>, and the <a href="http://www.thestar.com/news/gta/article/1173277--don-t-get-what-the-prof-s-talking-about-there-s-an-app-for-that">Toronto Star</a>. Following next week’s article, on &#8220;The Launch,&#8221; I will focus on metrics that will help you decide if your startup is succeeding or floundering.
</p>
<h2>Extra Reading:</h2>
<ol>
<li><a href="http://ryanhoover.me/post/40941425921/tactics-for-better-customer-interviews">Tactics for Better Customer Interviews</a></li>
<li><a href="http://www.nytimes.com/2013/01/20/opinion/sunday/secret-ingredient-for-success.html">Secret Ingredient for Success (The New York Times)</a></li>
</ol></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/21/why-you-should-be-nice-to-your-customers/">Why You Should Be Nice to Your Customers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-21T00:00:00-05:00" pubdate data-updated="true">Nov 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Being nice to your customers seems like a no brainer. It makes perfect business sense: happy customers are less likely to stop using your service and more likely to refer your service to their friends. However, there is another significant reason that being nice pays off. 
</p>
<p>
Running a startup can be a tough slog. You’re unsure if people like what you&#8217;re building enough for it to be successful. If you get some traction there will be people out there that will belittle your idea, or your execution. With all the unknowns, and the not-always-constructive criticism, it’s incredibly refreshing to interact with a nice customer that loves your product. 
</p>
<p> 
I’ve noticed that the nicer I am to customers the nicer they are back. This virtuous circle means that we get more and more people who are willing to provide thoughtful criticism and who are willing to meet with us and give us feedback. We have one customer that loves <a href="https://understoodit.com">Understoodit</a> so much that he just finished writing a blog post for us (to be posted in the next week). 
</p>
<p>  
After a difficult day in startup land it’s really gratifying to interact with a nice customer. It puts a face to an email address and makes the whole process of building software that much more interesting and fulfilling.
</p>
<p>
Make sure you’re nice to your customers, they may just be nice back. 
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/09/stripe-would-be-perfect-if/">Stripe Would Be Perfect If&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-09T00:00:00-05:00" pubdate data-updated="true">Nov 9<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
I was among many Canadian developers who where happy to hear that Stripe had come to Canada. We were planning on adding subscriptions to <a href="https://understoodit.com">Understoodit.com</a>, so the timing couldn’t have been better. We assumed that it would take a couple of days to integrate Stripe, but it actually took <a href="https://twitter.com/davidmisshula">@davidmisshula</a> and me 7 days. The process gave me some insights that I thought I’d share.
</p>
<p>
I’ve heard that Stripe is significantly easier to integrate than its competitors, however, having never integrated a payment system I have no comparison. Overall I think Stripe is excellent and I’m glad we chose it, however, there are 4 areas, that if improved, would make Stripe perfect: 1) getting started, 2) taxes, 3) invoices and 4) edge cases.
</p>
<h2>Getting Started</h2>
<p>
Having never integrated a payment system into a website I wanted to be as careful as possible. I wanted to make sure that I understood as many details as possible, and had time to carefully map out all the things that needed to be done before pushing it to production. What I would have really liked was a diagram of how Stripe worked. A good diagram is much easier for me to parse, and would have helped me to understand the text documentation much quicker.
</p>
<p>
For instance, below is one possible diagram that would show the potential set of events associated with a new user signing up for a subscription plan.
</p>
<div>
<img src="/images/Stripe-Diagram.png" alt="A diagram of Stripe Payments">
</div>
<h2>Taxes</h2>
<p style="text-align:center;">
<img src="/images/stripe-response.png" alt="Stripe response to does it deal with taxes">
</p>
<p>
Understoodit is based in Canada, obligating us to collect taxes from Canadians, but not our international customers. The kicker is that different provinces have different tax rates. In total there are 4 different tax rates and then no taxes for international customers, for a total of 5 different tax levels. We currently have 3 monthly plans, and their 3 yearly equivalents. This means that we had to create (3 + 3) x 5 = 30 plans within Stripe.
</p>
<p>
It would have been significantly easier if Stripe had had a ‘tax’ feature, in the same way they have coupons. If such a feature existed we’d only have had to create 6 plans in Stripe and 4 tax levels. This would result in Stripe invoices including the subtotal, amount of taxes and total (one less thing for us to calculate). While Stripe does a great job of prorating payments, when a user switches from one plan to another, it becomes tricky for us when they switch province. While calculating taxes isn’t that difficult for us to do, it’s just one more thing we have to get right. It’s one more thing we have to calculate when sending an invoice to our customers.
</p>
<h2>Invoices</h2>
<p style="text-align:center;">
  <img src="/images/37signals-invoice.png" alt="picture of a 37 signals invoice">
</p>
<p>
Every online subscription that I currently have sends me a simple invoice at the end of each billing period. Some have .pdfs attached that I can easily send to an accountant. Additionally, those services include admin panels that list all the past invoices and those can easily be downloaded as pdfs. 
</p>
<p>
It would be amazing if Stripe handled 1) emailing invoices and 2) creating a .pdfs of each invoice. Developers could provide simple HTML templates for email and pdf invoices and Stripe would fill in the blanks and send the invoice at the correct time, to the correct user. I suspect people would be willing to pay extra for this feature.
</p>
<h2>Edge Cases</h2>
<p>
Like any feature, there are multiple edge cases to a payment system. For instance here are a few that we dealt with:
</p>
<ul>
  <li>Upgrade plan, and simultaneously change provinces (e.g. tax rate)</li>
  <li>Downgrade plan and simultaneously change provinces (e.g tax rate)</li>
  <li>Change credit card info, but not billing address</li>
  <li>Change plan, but keep credit card and billing info the same</li>
</ul>

<p>
Stripe employees can no doubt enumerate many more edge cases than someone adding Stripe for the first time. It would be helpful if they provided a checklist of edge cases for developers. The checklist could also include common security concerns that developers should understand before rolling payments out.
</p>
<h2>Conclusions</h2>
<p>
With all the hype on Hacker News, I had this vision of Stripe being magically easy to integrate. While it wasn’t rocket science it was certainly more effort than I envisioned. The whole process was made significantly more difficult by having to handle taxes. 
</p>
<p>
I wonder if there would be value in Stripe conducting the following usability experiment. Get a dozen computer science and engineering undergrads and ask them each to integrate Stripe into an existing website. Stripe employees would sit with them and monitor their progress (or lack of), but provide no help. I suspect that they’d find some surprises in how novices approach Stripe integration. The information gained in such an experiment could help them create better documentation, reduce development burden and ultimately create a more perfect Stripe.
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/09/common-javascript-errors/">Common JavaScript Errors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-09T00:00:00-04:00" pubdate data-updated="true">Sep 9<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
 With the rise of thick client-side applications, and Node.js, JavaScript has become an increasingly important programming language. Despite its simplicity, JavaScript presents some difficulties for those new to the language. I thought it would be useful to outline several JavaScript errors that I commonly made when I was learning the language.
</p>

<h2>Scope: this, that and window</h2>
<p>
  Like many programming languages JavaScript provides internal access to objects using the keyword <code>this</code>. Unfortunately, what <code>this</code> refers to differs depending on what called the function containing <code>this</code>. A common example, shown below, is what happens when <code>setTimeout</code> is called. 
</p>
<p>
  In the example below a Dog object is created, with a bark function. The Dog ralph is instantiated with the name &#8216;Ralph&#8217; and when <code>ralph.bark()</code> is called, &#8220;Ralph&#8221; is printed to the console.
</p>
<p>
   What becomes confusing is what happens when <code>setTimeout</code> is called with the parameters <code>ralph.bark</code> and 500. After 500 milliseconds <code>ralph.bark</code> is called, however, nothing is printed to the console.
</p>

<figure class='code'><figcaption><span>The this problem</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">Dog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">name</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Dog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bark</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">ralph</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dog</span><span class="p">(</span><span class="s1">&#39;Ralph&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">()</span>
</span><span class='line'><span class="c1">// Ralph is printed to the console</span>
</span><span class='line'>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span> <span class="p">,</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'><span class="c1">// nothing is printed to the console</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  Mozilla Developer Network refers to the problem above as <a href="https://developer.mozilla.org/en-US/docs/DOM/window.setTimeout">&#8216;The &#8221;<code>this</code>&#8221; problem&#8217;</a>. What happens is <code>this</code> within <code>bark()</code> refers to the browser&#8217;s <code>window</code> variable when <code>bark()</code> is called from setTimeout.
</p>

<h3>Avoiding the <code>this</code> problem.</h3>
<figure class='code'><figcaption><span>Solutions to the this problem.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Works in JavaScript 1.8.5</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">ralph</span><span class="p">),</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using jQuery</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">,</span> <span class="nx">ralph</span> <span class="p">),</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using undescore.js</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">,</span> <span class="nx">ralph</span> <span class="p">),</span> <span class="mi">500</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using an anonymous function</span>
</span><span class='line'><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span> <span class="nx">ralph</span><span class="p">.</span><span class="nx">bark</span><span class="p">();</span> <span class="p">},</span> <span class="mi">500</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>
<p>In each of the above the bind, or proxy functions explicity ensure that <code>this</code> within <code>ralph.bark</code> refers to ralph and not <code>window</code>. In the final example an anonymous function is called and provides another way of fixing the <code>this</code> problem.</p>

<h2>Callbacks in Loops</h2>
<p>When I launched <a href="understoodit.com">Understoodit.com</a> in May I included a waitlist for interested users to signup. I was planning on inviting a few dozen users a day, however, due to a deluge of emails sending out invites was delayed by a week or two. 
</p>
<p>
To send the invites out, I went to Understoodit&#8217;s admin panel and seleted 40 people on the waiting list and clicked invite. A few days later I noticed that only a few individuals had accepted the invite. I looked at Postmark&#8217;s logs and noticed that invites were only sent to 5 individuals. What&#8217;s more those 5 individuals had received anywhere from 5 - 15 emails each. Meanwhile, the other 35 invitees had received no emails. The bug: I had a callback in a loop that iterated over all the selected invities and 1) called databaseModule.addInvitedUser, which created an invite token and added that invite to the database and 2) sent an email with the newly created token. Below is a simplification of the code, with error handling removed.</p>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">sendInviteEmails</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">emails</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">databaseModule</span><span class="p">.</span><span class="nx">addInvitedUser</span><span class="p">(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">token</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">emailModule</span><span class="p">.</span><span class="nx">sendInvite</span><span class="p">(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  What went wrong was that the anonymous function <a href="http://stackoverflow.com/a/3023979/146099">&#8220;captures the variable i, not its value&#8221;</a>.  The value of <code>i</code> is dependent on when the anonymous function is called, which varries depending on how long it takes to add the invited user to the database.
</p>
<p>
  The solution I used was to wrap the anonymous function with an <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">immediately invoked function expression</a> (IIFE). The IIFE &#8220;locks&#8221; in the value of <code>i</code> ensuring that <code>emailModule.sendInvite()</code> refers to a different value of i on each IIFE call. Alternatively, one could create a second function outside of the loop and then call that (see option 2), a solution that would likely be easier to read. 
</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// option 1</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendInviteEmails</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">emails</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">databaseModule</span><span class="p">.</span><span class="nx">addInvitedUser</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">token</span> <span class="p">){</span>
</span><span class='line'>        <span class="nx">emailModule</span><span class="p">.</span><span class="nx">sendInvite</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">})(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// option 2</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendOneInviteEmail</span><span class="p">(</span> <span class="nx">email</span> <span class="p">){</span>
</span><span class='line'>  <span class="nx">databaseModule</span><span class="p">.</span><span class="nx">addInvitedUser</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">token</span> <span class="p">){</span>
</span><span class='line'>    <span class="nx">emailModule</span><span class="p">.</span><span class="nx">sendInvite</span><span class="p">(</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">token</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendManyInviteEmails</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">){</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">emails</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
</span><span class='line'>    <span class="nx">sendOneInviteEmail</span><span class="p">(</span> <span class="nx">emails</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  The above quirk seems similar to a fairly common JavaScript interview question that takes the form of <a href="http://tobyho.com/2011/11/02/callbacks-in-loops/">adding event listeners to an array of links</a>.
</p>


<h2>Global Variables</h2>
<p>
  The problems with global variables have been discussed many times before. Suffice it to say that you should avoid them by using <code>var</code> (e.g. <code>var x = 0;</code> vs </code>x = 0;</code>) when first declearing a variable. If you have a variable that has unaccounted for properties or values, there&#8217;s a chance that a global variable could be to blame.
</p>
<p>
  I&#8217;d highly recommend defining all your variables at the top of the function to make it as clear as possible when a var is missing. Furthermore I&#8217;d recommend using <a href="http://www.jshint.com/">JSHint</a> which can warn you of global variables.
</p>

<h2>Values in HTML forms</h2>

<figure class='code'><figcaption><span>A drop down menu</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;order-sizes&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>Small<span class="nt">&lt;/option&gt;</span>
</span><span class='line'>  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>Medium<span class="nt">&lt;/option&gt;</span>
</span><span class='line'>  <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>Large<span class="nt">&lt;/option&gt;</span>
</span><span class='line'><span class="nt">&lt;/select&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>When it comes time to get the form&#8217;s values, and use them within an application, I usually do something like: </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">orderSize</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#order-sizes option:selected&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Thanks for ordering a small!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Unfortunately the value that jQuery returns is a <code>String</code>, and comparing it to 1, a <code>Number</code> returns false. Here are several solutions to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="p">)</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// last solution</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">orderSize</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#order-sizes option:selected&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="nx">orderSize</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">){</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  In the first two examples orderSize is explicitly converted to a <code>Number</code> using the <code>Number</code> constructor and the global <code>parseInt</code> function. In the third example the double equals coerces orderSize to a <code>Number</code> before comparing to 1 (<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Operators/Comparison_Operators?redirectlocale=en-US&redirectslug=Core_JavaScript_1.5_Reference%2FOperators%2FComparison_Operators">MDN on comparison operators</a>). However, I&#8217;d recommend going with the last approach, which allows you to use orderSize as a <code>Number</code> in multiple spots without having to repeatedly caste to a number. If you don&#8217;t like the last approach I&#8217;d recommend the first or second approach, since it seems to be generally preferred to use the strict equal (tripple equal signs) and not to use the double equal sign.
</p>

<h2>Conclusions</h2>
<p>
  Many of the above errors can be avoided by following JavaScript style guides (<a href="http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml">Google JavaScript Style Guide</a>, <a href="http://addyosmani.com/blog/javascript-style-guides-and-beautifiers/">Addy Osmani on Style Guides</a>). A sign of how tricky JavaScript is comes from <a href="https://github.com/styleguide/javascript">Github&#8217;s JavaScript Style guide</a> that goes as far to recommend avoiding JavaScript altogether and using CoffeeScript - a suggestion a few would disagree with!
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/04/redis-and-relational-data/">Redis and Relational Data</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-04T00:00:00-04:00" pubdate data-updated="true">Jun 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
  <strong>UPDATE:</strong> Based on the feedback in the comments (Phineas), I&#8217;ve added an index to the comments table and updated the results.
</p>
<p>
  Using the right tool for the job is a basic tenant amongst programmers. However, with all the currently available database options it&#8217;s increasingly difficult to figure out what the right tool is. Sometime it&#8217;s nice to have a very simple tool that can be used for many different tasks: Redis. Over the last 4 months I&#8217;ve been using Redis heavily and I&#8217;ve even started to use it for relational data. I&#8217;ve been curious to find out the performance differences between Redis and PostgreSQL. Below I&#8217;ll provide an example of storing a simple relational dataset in Redis, and I&#8217;ll look at the performance differences between Redis and PostgreSQL.
</p>

<h2>Why use Redis for Relational data?</h2>
<p>
  I find Redis appealing because it&#8217;s the simplest database that I have ever used (relative to: MySQL, PostgreSQL, Riak &amp; Mongo). The documentation includes the time complexity of each command, and the documentation provides an interactive console to experiment with a given command. There&#8217;s also a certain appeal to using a single database instead of 2 or 3: 
  <ol>
    <li>It&#8217;s much quicker to master 1 database than 2.</li>
    <li>Two different databases means twice the updates, bugs and crashes.</li>
  </ol>
</p>

<p>
  I&#8217;ll outline a few ways Redis can be used to store relational data and the performance differences between redis and PostgreSQL. All the examples and performance tests were done using Node.js.
</p>

<h2>Storing Relational Data in Redis</h2>

<p>
  Redis values can be 1 of 5 different datatypes: strings, hashes, lists, sets and sorted sets. Each row in a relational database can be represented using a hash, and a list, set or sorted set can be used to represent a table. The datatype that&#8217;s used to represent the table is dependent on how the data needs to be retrieved.
</p>

<p>
  For example, let&#8217;s say we&#8217;re storing blog posts. In Redis, each post will be stored in its own hash, with its key corresponding to the post&#8217;s url:
</p>

<figure class='code'><figcaption><span>A Post</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="s1">&#39;a-post-about-databases&#39;</span> <span class="o">:</span>
</span><span class='line'>  <span class="p">{</span> <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;A post about databases&#39;</span><span class="p">,</span> <span class="nx">body</span> <span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="nx">createdAt</span> <span class="o">:</span> <span class="mi">1338751532301</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  Retrieving a single post using the url becomes O(N), where N is the size of the hash (post). Since the number of keys in a post is constant, retrieving that post becomes O(1). However, if we wanted to get all the posts, or a subset of them, it becomes useful to also store the keys in a sorted set (e.g. the &#8220;table&#8221;). Using a sorted set means that posts can be stored by their createdAt date and it allows us to retrieve all the posts, or a subset of them (useful for pagination).
</p>


<figure class='code'><figcaption><span>Retrieving a subset of all posts</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">redis</span><span class="p">.</span><span class="nx">zrange</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">posts</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//return the keys (urls) associated with the first 11 posts</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">startDate</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nx">getTime</span><span class="p">()</span> <span class="p">;</span> <span class="c1">// June 1st</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">endDate</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">)).</span><span class="nx">getTime</span><span class="p">();</span> <span class="c1">// June 30th</span>
</span><span class='line'><span class="nx">redis</span><span class="p">.</span><span class="nx">zrangebyscore</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">startDate</span><span class="p">,</span> <span class="nx">endDate</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">posts</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//returns the keys (urls) associated with all the posts from June 2012</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>

<p>
  The above example is relatively straight forward, but what about storing the post&#8217;s comments? For every post we create a new sorted set called: &#8216;comments-KEYofPOST&#8217;. The comments are sorted by their creation time. To get a post, and its comments, we could do the following:
</p>

<figure class='code'><figcaption><span>Storing a post&#8217;s comments</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">postURL</span> <span class="o">=</span> <span class="s1">&#39;a-post-about-databases&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">multi</span> <span class="o">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">multi</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// queue up the queries</span>
</span><span class='line'><span class="nx">multi</span><span class="p">.</span><span class="nx">hgetall</span><span class="p">(</span><span class="nx">postURL</span><span class="p">);</span>
</span><span class='line'><span class="nx">multi</span><span class="p">.</span><span class="nx">zrange</span><span class="p">(</span><span class="s1">&#39;comments-&#39;</span> <span class="o">+</span> <span class="nx">postURL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// execute the queries atomically</span>
</span><span class='line'><span class="nx">multi</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">){</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  results[0] will contain the post</span>
</span><span class='line'><span class="cm">  results[1] will contain an array with all the comments</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Redis vs. PostgreSQL Performance</h2>

<p>
  In SQL you might do 1 query to get the post and another to get the comments, or use a join to get the post and the comments in one query. With the approach above, using Redis, 2 queries are atomically executed, using the multi and exec commands. Both in PostgreSQL, and Redis, a single request is sent the database to retrieve 1 post and its 10 comments.
</p>

<p>
  To test the the performance I created a dataset that includes 10,000 &#8216;blog posts&#8217;, with each post having 10 comments (100,000 comments in total). All tests were run on a 2011 Macbook Pro (2.3 GHz i7, 8GB RAM). To test PostgreSQL, I sequentially fetched each post and used a join to retrieve its comments (10,000 separate queries). The test was repeated six times to produce an average time and was done for both PostgreSQL and Redis.
</p>

<div class="table">
  <h2>Redis &amp; PostgreSQL Performance</h2>
  <table>
    <tr>
      <th></th>
      <th>Average Time (Seconds)</th>
      <th>Query (Milliseconds)</th>
    </tr>

    <tr>
      <td>psql</td>
      <td>138.34</td>
      <td>13.8</td>
    </tr>

    <tr>
      <td>psql (Native Bindings - NB)</td>
      <td>125.95</td>
      <td>12.6</td>
    </tr>

    <tr>
      <td>psql (NB + Index)</td>
      <td>2.72</td>
      <td>0.27</td>
    </tr>

    <tr>
      <td>Redis (Hires)</td>
      <td>0.76</td>
      <td>0.067</td>
    </tr>

  </table>
</div>

<p>
  Using PostgreSQL, it took an average of 138.34 seconds to execute all 10,000 queries, or 13.8 milliseconds/query. Using the native bindings, that come with the psql node module, yielded an improvement and was associated with 12.6 milliseconds/query. When an index was added to comments (post_id), the time dropped to 2.72 seconds, or 0.27 milliseconds for a post and its 10 comments. In contrast, Redis can retrieve a post and its comments in 0.067 milliseconds. Of course the above is akin to comparing apples to oranges, but it still provides a glimpse into the performance differences between Redis and PostgreSQL.
</p>
<p>
  While Redis is in memory and should be fast, PostgreSQL uses caching algorithms (<a href="http://archives.postgresql.org/pgsql-hackers/2007-11/msg00562.php">LRU</a>) to keep its contents in memory. Of course, keeping everything in memory (Redis) will most likely be faster than using LRU.
</p>

<h2>Caveats to using Redis for Relational Data</h2>

<p>
  The single biggest caveat to using Redis, is that it is entirely in memory. If your relational dataset is 2.5GB (not that large), you&#8217;ll need a $160/month Linode (4GB RAM) to keep it in Redis. In contrast, a $20/month Linode (512MB RAM) has 20GB of disk space and could easily hold that same dataset using PostgreSQL. This tradeoff becomes even more of an issue as your dataset become larger than 4GB. 
</p>

<p>
  The above example only represents a very simple relationship between two pieces of data (posts and comments), mapping a many-to-many relationship in Redis would take a little more imagination. 
</p>

<h2>Conclusions</h2>
<p>
  Before storing all your app&#8217;s data in Redis it&#8217;s advisable to estimate how large your dataset will be in a year, or two, and how much much RAM will be required to use Redis. If your dataset will be greater than 4GB in a year, and money is a constraint, it probably makes sense to put all, or a portion of the data, in PostgreSQL, or use an alternative noSQL solution (e.g. Riak or Mongo).
</p>

<p>
<a class="github" href="https://github.com/liamks/Redis-and-Relational-Data"><span></span>Code on Github</a>
</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/21/adding-authentication-waiting-lists-and-sign-ups-to-and-express-app-using-drawbridge-and-redis/">Adding Authentication, Waiting Lists and Sign Ups to an Express App Using Drawbridge.js and Redis</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-21T00:00:00-04:00" pubdate data-updated="true">Apr 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
There are several popular modules for adding password-based user authentication to an Express.js app. Unfortunately, they require writing lots of code to get started. I prefer the approach that authentication libraries like Devise take: they generate code and views, and you’re free to modify, or delete, what’s created. 
</p>

<p>
Given the authentication options for Express.js I wanted to create a module that would make adding user authentication quick and easy. Moreover, I also wanted developers to be free to edit and modify the generated views. In addition to authentication I wanted the module to handle sign ups (the type you see on a just-launched startup’s page) and to handle waiting lists and invitations. Based on the module&#8217;s functionality I&#8217;ve decided to call it Drawbridge.js.
</p>

<h2>User Authentication with Drawbridge.js</h2>
<p>
Drawbridge.js uses Redis to persists its data, but it’s possible for developers to create other database adapters for Drawbridge (pull-requests accepted). I chose Redis because its ability to pipeline multiple commands reducing round trips between the server and the database. The atomic nature of pipelined commands obviates a lot of complex callbacks and makes the resulting code much easier to understand. Overall Redis is easy to use, easy to understand and fast - great features for an authentication module. 
</p>
<p>
To send email, Drawbridge uses either nodemailer, or the postmark modules. I included the <a href="https://postmarkapp.com">Postmark</a> option because I&#8217;m currently using it and I like it. However, developers are free to add additional email adapters.
</p>

<h2>Drawbridge Screencast</h2>
<p>
I’ve created a short screencast to show how easy it is to add drawbridge to an existing Express.js application. Before you watch the screencast it’s important that I outline a couple of caveats:
</p>
<p>
  <ol>
    <li>Drawbridge is not ready for production - it’s basically a working prototype.</li>
    <li>Drawbridge views and variables are inconsistently named, that will need to be fixed.</li>
    <li>The code needs refactoring and more testing.</li>
    <li>Drawbridge needs to be picked apart for security issues.</li>
  </ol>
</p>
<p>
With those caveats out of the way here is the video:
</p>

<p>
<iframe src="http://player.vimeo.com/video/40780990?title=0&amp;byline=0&amp;portrait=0" width="400" height="300" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe><p><a href="http://vimeo.com/40780990">Drawbridge.js</a> from <a href="http://vimeo.com/user11381617">Liam Kaufman</a> on <a href="http://vimeo.com">Vimeo</a>.</p>
</p>

<p>
While I built Drawbridge.js to scratch my own itch, I hope others will find it useful as well. Once I refine it further I will most certainly start to use it in my own projects. If you’re interested in Drawbridge 1) watch the project on Github and 2) try and get it working on your toy Express apps. I welcome feedback on both the architecture of Drawbridge and its security.
</p>

<p>
<a class="github" href="https://github.com/liamks/Drawbridge.js"><span></span>Drawbridge.js on Github</a>
</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/22/making-hacker-news-faster-two-approaches/">Making Hacker News Faster: Two Approaches</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-22T00:00:00-04:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Over the years traffic to <a href="http://news.ycombinator.com">Hacker News (HN)</a>, &#8220;a social news website about computer hacking and startup companies&#8221; <a href="http://en.wikipedia.org/wiki/Hacker_News">(Wikipedia)</a>, has grown consistently, with an <a href=”http://www.ycombinator.com/images/hntraffic-5mar12.png”>average of 150,000 daily uniques</a>. The growth in traffic may explain why load times seem increasingly variable. I couldn’t help but wonder if some optimizations could be made to decrease both variability and load times. I&#8217;ll propose two broad approaches, the first involves migrating away from table based layouts while the second involves consuming a JSON API.
</p>

<h2> Approach 1: Tables to Divs </h2>

<div class="table">
  <h2> Table 1. Hacker News Resource Statistics </h2>
  <table>
    <tr>
      <th>Resource</th>
      <th>Size (With Tables) </th>
      <th>Size (With Divs) </th>
      <th>% Change </th>
    </tr>
    <tr>
      <td>HTML</td>
      <td>26KB</td>
      <td>15KB</td>
      <td>-42%</td>
    </tr>
    <tr>
      <td>CSS</td>
      <td>1.7KB</td>
      <td>2.3KB</td>
      <td>+35%</td>
    </tr>
    <tr>
      <td>Logo</td>
      <td>100B</td>
      <td>0</td>
      <td>-100%</td>
    </tr>
    <tr>
      <td>Up Arrow</td>
      <td>111B</td>
      <td>0</td>
      <td>-100%</td>
    </tr>
    <tr>
      <td>Total</td>
      <td>27.9KB</td>
      <td>17.3KB</td>
      <td>-37.2%</td>
    </tr>
  </table>
  <p>
    In the DIV version, the logo and up arrow were base 64 encoded and included in the HTML and CSS files. 
  </p>
</div>

<p>
  HN&#8217;s front page is comprised of: 4 tables, 98 rows, 159 columns, 37 inline style declarations and numerous attributes that dictate style. To reduce the markup on the front page I created a new HN front page (<a href="https://github.com/liamks/Making-HN-Faster/blob/master/HackerNewsV2.html">Github link</a>) that looks identical to the existing page but does not include tables or inline css. I also went a step further and base64 encoded both the logo and the up arrow to decrease the number of requests. The completed CSS file was run through a <a href="http://www.minifycss.com/css-compressor/">css minifyer</a> to yield further reductions. With those changes only two requests are necessary, one for the HTML file and one for the CSS file. Table 1 shows that those changes yielded an overall reduction of 37%.
</p>

<p>
  I also slightly modified the JavaScript responsible for sending up-votes to the server. Instead of grabbing a vote&#8217;s id from the id of the HTML node, it gets it from the &#8216;data-id&#8217; attribute. Otherwise, the JavaScript remains identical. As an aside, if you have not examined the JavaScript that is responsible for sending votes to the server, I&#8217;ve included it below (the existing code). It&#8217;s a creative use of an image tag. An image node is created, but not added to the DOM. When the image node is assigned a &#8216;src&#8217;, which happens to include all the vote info, it then requests the &#8216;image&#8217;, using the constructed url. Thus the &#8216;image&#8217; request becomes analogous to an AJAX GET request, but without a conventional response.
</p>

<figure class='code'><figcaption><span>Votes With IMG Nodes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">byId</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">vote</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/_/</span><span class="p">);</span>   <span class="c1">// {&#39;up&#39;, &#39;123&#39;}</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// hide arrows</span>
</span><span class='line'>  <span class="nx">byId</span><span class="p">(</span><span class="s1">&#39;up_&#39;</span>   <span class="o">+</span> <span class="nx">item</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">byId</span><span class="p">(</span><span class="s1">&#39;down_&#39;</span> <span class="o">+</span> <span class="nx">item</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ping server</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">ping</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">ping</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// cancel browser nav</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2> Approach 2: JSON API </h2>
<p>
  Although approach 1 results in a 37% decrease in data transferred to the client, markup and data must be transferred to the client on every refresh. In approach two, the markup is only transferred to the client once, and then cached, while the data is sent the client via JSON. Using this approach would decrease the HTML file but no doubt increase the JavaScript file. However, both of those resources could be cached in browser, and cached on a CDN, drastically reducing the number of requests to HN&#8217;s server. Furthermore, the JSON representing the stories on the front page <a href="https://github.com/liamks/Making-HN-Faster/blob/master/frontpage.json">is 7.8KB</a>, much smaller than the amount size of the existing solution or even approach 1.
</p>

<p>
  Approach 2 is not without its drawbacks. It would require significant changes in both HN&#8217;s backend and large changes to the client-side. A JavaScript application and API would have to be created. This approach would likely be incompatible with bots that would not execute the JavaScript necessary to populate the page with stories. To get around this the agent-type could be detected and a static version could be served to bots. Alternatively, the webpage could be pre-populated with stories and subsequent requests would take advantage of AJAX get requests. This would simplify matters, but make caching more difficult, since the cache page would require updating every time the front page changes.
</p>

<h2> Conlusions </h2>
<p>
  By transitioning from tables to divs, and inline css to external css, HN could dramatically reduce the bandwidth required to serve its web pages. The first approach would require minimal changes to HN&#8217;s back-end making it a good candidate for adoption. While the second approach could yield even better results, it would require drastic changes to both the server and the client, making it more suitable as a long term solution.
</p>
<p>
  In addition to the two approaches above, gzip compressing both the .html and the .css would further reduce transferred data. It would also be beneficial to add the appropriate headers to enable browser caching for CSS.
</p>
<p>
  While Paul Graham may have insufficient time, or interests, in implementing some of the above changes, I suspect he knows a few individuals who would be willing to help out.
</p>

<p>
<a class="github" href="https://github.com/liamks/Making-HN-Faster"><span></span>Code on Github</a>
</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  <div class='social'>

  <a id="twitter" href="https://twitter.com/liamkaufman"><span></span>@liamkaufman</a>
  <a id="github" href="https://github.com/liamks"><span></span>@liamks</a>
  <a id="linked-in" href="http://www.linkedin.com/pub/liam-kaufman/1b/7b4/2a4"><span></span>Liam Kaufman</a> 
</div>


  <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/02/27/adding-real-time-to-a-restful-rails-app/">Adding Real-Time To A RESTful Rails App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/08/three-important-conversion-metrics-you-should-watch/">Three Important Conversion Metrics You Should Watch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/30/are-you-ready-to-launch/">Are You Ready To Launch?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/22/making-software-people-want-before-launching/">Before Launching Build Software People Use</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/21/why-you-should-be-nice-to-your-customers/">Why You Should Be Nice To Your Customers</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("liamkaufman", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/liamkaufman">@liamkaufman</a></p>
  
</section>








</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Liam Kaufman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'liamkaufman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





    

<script type="text/javascript">
      var disqus_shortname = 'liamkaufman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  <script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
  </script>
</body>
</html>
